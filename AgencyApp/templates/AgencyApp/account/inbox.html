{% extends "base.html" %}

{% block content %}
{% load static %}
<link href="{% static "/AgencyApp/css/profile.css" %}" rel="stylesheet" type="text/css" media="all" />
<link href="{% static "/AgencyApp/css/message.css" %}" rel="stylesheet" type="text/css" media="all" />

<script>

function getWideInboxFeed(){
    var feedString = "<div style='width: 100%; height: 500px; position: relative;'>"

    {% if messages %}
        // Add message choice panel
        feedString += "<div style='position: absolute; left: 0; top: 0; bottom: 0; width: 32%; background: rgba(0,0,0,0.05);'><div style='position: relative; height: 100%; width: 100%';>"

        // Add tabs at the top
        feedString += "<ul class='profileTabButtonList' style='margin-top: 5px; z-index: 0; width: 100%;'>"
        feedString += "<li id='inboxTabButton' style='width: 48%; margin-left: 0px;' onclick='selectMessageTab(" + '"inbox");' + "'>Inbox<div id='inboxTabButtonBorderCover' class='profileTabButtonBorderCover' style='margin-top: 10px; height: 2px;'></div></li>";
        feedString += "<li id='sentTabButton' style='width: 48%; margin-left: 3.5px;' onclick='selectMessageTab(" + '"sent");' + "'>Sent<div id='sentTabButtonBorderCover' class='profileTabButtonBorderCover' style='margin-top: 10px;'></li>";
        feedString += "</ul>"

        // Add list container
        feedString += "<div id='messageListContainer' style='position: relative; background: #FFF; border: 1px solid #000; height: 457px; margin-top: -30px; z-index: 2;'></div>";

        feedString += "</div></div>"

        // Add current message panel
        feedString += "<div style='position: absolute; top: 0; bottom: 0; right: 0;width: 68%; background: #aba;'>"

        feedString += "</div>"
    {% endif %}

    feedString += "</div>";
    return feedString
}

var activeMessageTab;
var messageTabButtons = ["inbox", "sent"]
function selectMessageTab(tabType){
    for(var i=0; i < messageTabButtons.length; i++){
        var button = document.getElementById(messageTabButtons[i] + "TabButton");
        var borderCover = document.getElementById(messageTabButtons[i] + "TabButtonBorderCover");
        if(button != null && borderCover != null){
            if(messageTabButtons[i] === tabType){
                activeMessageTab = tabType
                button.className = "active";
                borderCover.style.opacity = "1";
            }else{
                button.className = "";
                borderCover.style.opacity = "0";
            }
        }
    }

    var messageList;
    {% if messages %}
        var messages = {{messages|safe}}
        if(tabType in messages && messages[tabType] != null && messages[tabType].length > 0){
            messageList = messages[tabType]
        }
    {% endif %}
    var container = document.getElementById("messageListContainer");
    if(container != null){
        container.innerHTML = getMessageListString(messageList, tabType);
    }
}

function getMessageListString(messageList, listType){
    var listString = "<div style='width: 100%; height: 100%; border 0px solid #000; margin-top: 0px;'>"
    if(messageList != null && messageList.length > 0){
        listString += "<ul id='messageFeed' class='messageFeed'>"
        for(var i=0; i < messageList.length; i++){
            var displayUser = messageList[i]["sender"];
            if(listType === "sent"){
                displayUser = messageList[i]["recipient"];
            }
            listString += "<li id='messageFeedElement_" + messageList[i]["messageID"] + "' onclick='displayMessage(" + '"' + messageList[i]["messageID"] + '"' + ");'>"

            // Add picture
            listString += "<div style='position: absolute; left: 5px; top: 5px; bottom: 5px;'><img style='max-height: 100%;' src='" + displayUser["profilePictureURL"] + "'></div>"

            // Add text container
            listString += "<div style='position: absolute; left: 64px; top: 13px; bottom: 5px; right: 5px; text-align: left;'>"
            listString += "<h4 style='margin: 0; font-size: 1.1em;'>" + displayUser["cleanName"] + "</h4>"
            listString += "<div style='margin-top: -1px; font-size: 0.9em; font-weight: 100; color: rgba(0,0,0,0.6);  text-overflow: ellipsis; height: 60%; white-space: nowrap; overflow: hidden;'>" + messageList[i]["content"] + "</div>";
            listString += "</div>"

            listString +="</li>"
        }
        listString += "</ul>"
    }else{
        listString += "<div style='margin-top: 10px; font-size: 0.9em; color: rgba(0,0,0,0.7);'>No messages</div>"
    }
    listString += "</div>"
    return listString
}

function displayMessage(messageID){
    var messageFeed = document.getElementById("messageFeed")
    var messageElement = document.getElementById("messageFeedElement_" + messageID);
    if(messageFeed != null && messageElement != null){
        var elements = messageFeed.getElementsByTagName("li");
        for(var i=0; i < elements.length; i++){
            if(elements[i].id === messageElement.id){
                messageElement.className = "active";
            }else{
                elements[i].className = "";
            }
        }
    }
}

function getSlimInboxFeed(){

}

</script>


<div id='backgroundPanel' class='backgroundPanel' style='min-width: 634px; min-height: 100%;'>
    <div id="mainViewPanel" class="mainViewPanel" style="position: relative; min-width: 620px; max-width: 675px; background: rgba(0,0,0,0.05); border: none;">
        <div style='height: 100%; width: 100%; background: #FFF;'>
            <script>
                document.write(getWideInboxFeed())
                selectMessageTab("inbox")
            </script>
        </div>
    </div>
</div>
{% endblock %}