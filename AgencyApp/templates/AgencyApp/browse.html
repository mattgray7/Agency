{% extends "base.html" %}

{% block content %}

<div id="eventsViewDiv"></div>
<div id="projectsViewDiv"></div>
<div id="postsViewDiv"></div>
<div id="usersViewDiv"></div>
<br>
<div id="cancelButton"></div>
<div id="browseCancelButton"></div>

{% if source == possibleDestinations.viewPost %}
	<script>
	$(document).ready(function(){
		var cancelButtonDiv2 = document.getElementById("browseCancelButton");
		var cancelButton2 = createCancelButton(cancelButtonDiv2, "{{ possibleDestinations.browse }}", "{{ currentPageURL }}", "Back to browse")
	});
	</script>
{% endif %}

<!--<div id="collabViewDiv"></div>
<div id="workViewDiv"></div>
<div id="castingViewDiv"></div>-->

<script>/* TODO use this function when I have internet to fio how to pass django objects to a functino
	function addPostPictureColumn(post){
		// Add empty column even if a pic exists
		var colString = '<td>';
		{% if post.postPicture %}
			colString += '<img src="' + post.postPicture.url + '" height="50px" width="70px"/>'
		{% else %}
			//TODO add a default pic
			console.log(picURL)
			colString += '<img height="50px" width="70px"/>'
		{% endif %}
		colString += '</td>';
		return colString
	}*/

	/* TODO figure out how to make ajax call blocking when I get internet
	function getFollowingCol(postID){
		var followingCol = null;
		$.ajax({
			url : "/ajax/getPostFollowingBool/",
			data : {"postID": postID},
			type : 'POST',
			dataType: "json",
			success : function(data) {
				followingCol += "<td>"
				console.log("1. followingCol is " + followingCol);

				if(data["following"]){
					followingCol += "&#10004";
				}
				followingCol += "</td>";
			}
		});
		return followingCol
	}*/
	var posterNameMap = {{ posterNameMap|safe }};


	function getFollowingCol(postID){
		var colString = "<td>";
		{% for followingPostID in followingPostIDs %}
			if(postID == "{{followingPostID}}"){
				colString += "&#10004";
				//TODO add django for loop break
			}
		{% endfor %}
		colString += "</td>";
		return colString
	}

	function createViewEventsTable(){
		var tableString = '<h3>Browse events</h3>';
		{% if events %}
			tableString += '<table>';
			tableString += ("<tr> " +
								"<td></td>"	+  //post picture
								"<td> Title </td>" +
								"<td> Posted by </td>" +
								"<td> Date </td>" +
								"<td> Location </td>" +
								"<td> Description </td>" +
								"<td> Following </td>" +	// TODO don't add following column if user is not logged in
							"</tr>");

			//Add each event

			{% for eventObj in events %}
				var pictureCol = '<td>';
				{% if eventObj.postPicture %}
					pictureCol += '<img src="{{ eventObj.postPicture.url }}" height="50px" width="70px"/>'
				{% else %}
					pictureCol += '<img height="50px" width="70px"/>'
				{% endif %}
				pictureCol += '</td>';

				tableString += ("<tr>" + pictureCol +
									"<td><button onclick='createPostRedirectForm(" + '"{{eventObj.postID}}","{{possibleDestinations.viewPost}}"' + ");'>{{eventObj.title}}</button></td>" +
									"<td><div id='" + getNextProfileName() + "'>{{eventObj.poster}}</td>" +
									"<td>{{eventObj.date}}</td>" +
									"<td>{{eventObj.location}}</td>" +
									"<td>{{eventObj.description}}</td>" + getFollowingCol("{{eventObj.postID}}") + 
								"</tr>");
			{% endfor %}
			tableString += "</table>";
		{% endif %}
		return tableString;
	};

	function createViewProjectsTable(){
		var tableString = '<h3>Browse projects</h3>';
		{% if projects %}
			tableString += '<table>';
			tableString += ("<tr><td></td>" +
								"<td> Title </td>" +
								"<td> Posted by </td>" +
								"<td> Status </td>" +
								"<td> Description </td>" +
								"<td> Following </td>" +
							"</tr>");

			//Add each event
			{% for projectObj in projects %}
				var pictureCol = '<td>';
				{% if projectObj.postPicture %}
					pictureCol += '<img src="{{ projectObj.postPicture.url }}" height="50px" width="70px"/>'
				{% else %}
					pictureCol += '<img height="50px" width="70px"/>'
				{% endif %}
				pictureCol += '</td>';
				tableString += ("<tr>" + pictureCol +
									"<td><button onclick='createPostRedirectForm(" + '"{{projectObj.postID}}","{{possibleDestinations.viewPost}}"' + ");'>{{projectObj.title}}</button></td>" +
										"<td><div id='" + getNextProfileName() + "'>{{projectObj.poster}}</td>" +
									"<td>{{projectObj.status}}</td>" +
									"<td>{{projectObj.description}}</td>" + getFollowingCol("{{projectObj.postID}}") +
								"</tr>");

			{% endfor %}
			tableString += "</table>";
		{% endif %}
		return tableString;
	};

	function createViewUsersTable(){
		var tableString = '<h3>Browse users</h3>';
		{% if users %}
			tableString += '<table>';
			tableString += ("<tr><td></td>" +
								"<td> Name </td>" +
								"<td> Seeking </td>" +
							"</tr>");

			//Add each event
			var posterNameMap = {{ posterNameMap|safe }};
			{% for userObj in users %}
				var pictureCol = '<td>';
				{% if userObj.profilePicture %}
					pictureCol += '<img src="{{ userObj.profilePicture.url }}" height="50px" width="70px"/>'
				{% else %}
					pictureCol += '<img height="50px" width="70px"/>'
				{% endif %}
				pictureCol += '</td>';
				tableString += ("<tr>" + pictureCol +
									"<td><button onclick='createProfileRedirectForm(" + '"{{userObj.username}}"' + ");'>" + posterNameMap["{{userObj.username}}"] + "</button></td>" +
								"</tr>");

			{% endfor %}
			tableString += "</table>";
		{% endif %}
		return tableString;
	};

	function createViewCollabPostTable(){
		var tableString = '<h3>Browse posts seeking collaborators</h3>';
		{% if posts.collaboration %}
			tableString += '<table>';
			tableString += ("<tr><td></td>" +
								"<td> Title </td>" +
								"<td> Posted by </td>" +
								"<td> Seeking </td>" +
								"<td> Description </td>" +
								"<td> Following </td>" +
							"</tr>");

			//Add each event
			{% for collabObj in posts.collaboration %}
				var pictureCol = '<td>';
				{% if collabObj.postPicture %}
					pictureCol += '<img src="{{ collabObj.postPicture.url }}" height="50px" width="70px"/>'
				{% else %}
					pictureCol += '<img height="50px" width="70px"/>'
				{% endif %}
				pictureCol += '</td>';
				tableString += ("<tr>" + pictureCol +
									"<td><button onclick='createPostRedirectForm(" + '"{{collabObj.postID}}","{{possibleDestinations.viewPost}}"' + ");'>{{collabObj.title}}</button></td>" +
									"<td><div id='" + getNextProfileName() + "'>{{collabObj.poster}}</td>" +
									"<td>{{collabObj.collaboratorRole}}</td>" +
									"<td>{{collabObj.description}}</td>" + getFollowingCol("{{collabObj.postID}}") +
								"</tr>");

			{% endfor %}
			tableString += "</table>";
			console.log(tableString)
		{% endif %}
		return tableString;
	};


	function createViewWorkPostTable(){
		var tableString = '<h3>Browse posts seeking crew members</h3>';
		{% if posts.work %}
			tableString += '<table>';
			tableString += ("<tr><td></td>" +
								"<td> Title </td>" +
								"<td> Posted by </td>" +
								"<td> Seeking </td>" +
								"<td> Description </td>" +
								"<td> Paid </td>" +
								"<td> Following </td>" +
							"</tr>");

			//Add each event
			{% for workObj in posts.work %}
				var pictureCol = '<td>';
				{% if workObj.postPicture %}
					pictureCol += '<img src="{{ workObj.postPicture.url }}" height="50px" width="70px"/>'
				{% else %}
					pictureCol += '<img height="50px" width="70px"/>'
				{% endif %}
				pictureCol += '</td>';
				tableString += ("<tr>" + pictureCol +
									"<td><button onclick='createPostRedirectForm(" + '"{{workObj.postID}}","{{possibleDestinations.viewPost}}"' + ");'>{{workObj.title}}</button></td>" +
									"<td><div id='" + getNextProfileName() + "'>{{workObj.poster}}</td>" +
									"<td>{{workObj.profession}}</td>" +
									"<td>{{workObj.description}}</td>")
				
				// Add tick or x for paid
				{% if workObj.paid %}
					tableString += "<td>&#10004;</td>";
				{% else %}
					tableString += "<td></td>";
				{% endif %}
				tableString += getFollowingCol("{{workObj.postID}}");
				tableString += "</tr>";
			{% endfor %}
			tableString += "</table>";
		{% endif %}
		return tableString;
	};

	function createViewCastingPostTable(){
		var tableString = '<h3>Browse casting posts</h3>';
		{% if posts.casting %}
			tableString += '<table>';
			tableString += ("<tr><td></td>" +
								"<td> Title </td>" +
								"<td> Posted by </td>" +
								"<td> Description </td>" +
								"<td> Paid </td>" +
								"<td> Following </td>" +
							"</tr>");

			//Add each event
			{% for castingObj in posts.casting %}
				var pictureCol = '<td>';
				{% if castingObj.postPicture %}
					pictureCol += '<img src="{{ castingObj.postPicture.url }}" height="50px" width="70px"/>'
				{% else %}
					pictureCol += '<img height="50px" width="70px"/>'
				{% endif %}
				pictureCol += '</td>';
				tableString += ("<tr>" + pictureCol +
									"<td><button onclick='createPostRedirectForm(" + '"{{castingObj.postID}}","{{possibleDestinations.viewPost}}"' + ");'>{{castingObj.title}}</button></td>" +
									"<td><div id='" + getNextProfileName() + "'>{{castingObj.poster}}</td>" +
									"<td>{{castingObj.description}}</td>")
				
				// Add tick or x for paid
				{% if castingObj.paid %}
					tableString += "<td>&#10004;</td>";
				{% else %}
					tableString += "<td></td>";
				{% endif %}
				tableString += getFollowingCol("{{castingObj.postID}}");
				tableString += "</tr>";
			{% endfor %}
			tableString += "</table>";
		{% endif %}
		return tableString;
	};

	function createPostRedirectForm(postID, destinationPageName){
		//Create a dict with the postID
		var extraInputs = []
		extraInputs.push({key: "postID", value: postID});
		var form = createPageRedirectForm("{{ next }}", "{{ next }}", destinationPageName, "{{ currentPageURL }}", extraInputs);
		form.submit();
	}

	function createProfileRedirectForm(username){
		var extraInputs = []
		extraInputs.push({key: "profileName", value: username});
		console.log("next: {{next}}, profile: {{possibleDestinations.profile}}")
		var form = createPageRedirectForm("{{ next }}", "{{ next }}", "{{ possibleDestinations.profile }}", "{{ currentPageURL }}", extraInputs);
		console.log("{{currentPageURL}}")
		form.submit();
	}

	$(document).ready(function(){
		if("{{browseType}}" == "{{possibleViews.events}}"){
			{% if events %}
				document.getElementById("eventsViewDiv").innerHTML = createViewEventsTable();
			{% else %}
				document.getElementById("eventsViewDiv").innerHTML = "<h3> No events posted </h3>";
			{% endif %}
		}else if("{{browseType}}" == "{{possibleViews.projects}}"){
			{% if projects %}
				document.getElementById("projectsViewDiv").innerHTML = createViewProjectsTable();
			{% else %}
				document.getElementById("projectsViewDiv").innerHTML = "<h3> No projects posted </h3>";
			{% endif %}
		}else if("{{browseType}}" == "{{possibleViews.users}}"){
			{% if posterNameMap %}
				document.getElementById("usersViewDiv").innerHTML = createViewUsersTable();
			{% else %}
				document.getElementById("usersViewDiv").innerHTML = "<h3> No users registered</h3>";
			{% endif %}
		}else if("{{browseType}}" == "{{possibleViews.posts}}"){
			var postDivHTML = "";
			{% if posts.collaboration %}
				postDivHTML += createViewCollabPostTable();
			{% else %}
				postDivHTML +="<h3> No collaboration ads posted</h3>";
			{% endif %}

			{% if posts.work %}
				postDivHTML += createViewWorkPostTable();
			{% else %}
				postDivHTML +="<h3> No work ads posted</h3>";
			{% endif %}

			{% if posts.casting %}
				postDivHTML += createViewCastingPostTable();
			{% else %}
				postDivHTML +="<h3> No casting ads posted</h3>";
			{% endif %}
			document.getElementById("postsViewDiv").innerHTML = postDivHTML;
		}
	});
</script>

{% endblock %}
