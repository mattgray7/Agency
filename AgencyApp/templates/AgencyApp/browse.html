{% extends "base.html" %}

{% block content %}
{% load static %}
<link href="{% static "/AgencyApp/css/browse.css" %}" rel="stylesheet" type="text/css" media="all" />
<script type="text/javascript" src="{% static "/AgencyApp/js/post/post.js" %}"></script>
<script type="text/javascript" src="{% static "/AgencyApp/js/browse.js" %}"></script>

<script>
    var browseTabs = ["jobs", "roles", "users", "projects", "events"];
    var activeTabs = [];
    var expandedTabDict = {"jobs": true, "roles": true, "users": true, "projects": true, "events": true};
    function selectBrowseTab(browseType){
        var browseButton = document.getElementById(browseType + "BrowseCategoryButton")
        if(browseButton != null){
            // If button is active, deactivate it (and vice versa)
            var activeTabListIndex = activeTabs.indexOf(browseType)
            if(activeTabListIndex > -1){
                activeTabs.splice(activeTabListIndex, 1)
                browseButton.className = "";
            }else{
                activeTabs.push(browseType);
                browseButton.className = "active";
            }
        }
        if(document.getElementById("searchTextInput").value === ""){
            if(!firstSearch){
                submitSearch()
            }
        }else{
            submitSearch()
        }
    }

    function updateBrowseResults(results){
        var resultsPanel = document.getElementById("searchResultsPanel")
        var browseResultsTableString = createSearchResultsDisplay(results)
        if(browseResultsTableString != null && browseResultsTableString.length > 0){
            // Add results content, can now access height of elements
            resultsPanel.innerHTML = browseResultsTableString;
            resultsPanel.style.display = 'block';

            // Save expanded section heights
            saveExpandedBrowseSectionHeights();

            // Update browse content container
            updateBrowseContentHeight();
        }
    }

    var firstSearch = true;
    var currentSearchResults = {};
    function submitSearch(){
        var searchValue = ''
        var searchInput = document.getElementById("searchTextInput");
        if(searchInput != null && searchInput.value != null && searchInput.value.length > 0){
            searchValue = searchInput.value;
        }

        var dropdown = document.getElementById("browseDropdown");
        if(dropdown != null){
            dropdown.style.display = "none";
            dropdown.innerHTML = "";
        }

        var resultsPanel = document.getElementById("searchResultsPanel")
        if(activeTabs.length != 0){
            $.ajax({
                url : "/ajax/getSearchResults/",
                data : {"categories": activeTabs, "searchValue": searchValue, "filters": JSON.stringify(getSearchFilterValues())},
                type : 'POST',
                dataType: "json",
                success : function(data) {
                    if(data["success"]){
                        if(data["results"]){
                            if(resultsPanel != null){
                                // Update global dict with new results
                                currentSearchResults = data["results"]
                                updateBrowseResults(data["results"])
                                if(firstSearch){
                                    firstSearch = false;
                                    $("#mainViewPanel").animate({marginTop: "0px"}, 500, function(){});
                                }
                            }
                        }
                    }
                }
            });
        }
    }

    var filterSectionHeights = {"jobs": 125, "roles": 210};
    var filterPanelMap = {"jobs": getJobsFilters, "roles": getRolesFiltersString, "users": getUsersFiltersString, "projects": getProjectsFiltersString, "events": getEventsFiltersString}
    function createFilterPanel(){
        var panelString = "<ul>"
        var callbacks = []
        for(var i=0; i < activeTabs.length; i++){
            var filterPanel = filterPanelMap[activeTabs[i]]()
            panelString += "<li id='" + activeTabs[i] + "FilterRow' style='height: " + filterSectionHeights[activeTabs[i]] + "px;'>" + filterPanel["html"] + "</li>";
            if(filterPanel["callbacks"].length > 0){
                callbacks = callbacks.concat(filterPanel["callbacks"])
            }
        }
        panelString += "</ul>";
        return {"html": panelString, "callbacks": callbacks}
    }

    /*function toggleProfessionChoiceRow(toggleType, filterType){
        var row = document.getElementById(filterType + "ProfessionChoiceRow");
        if(row != null){
            if(toggleType === "expand"){
                $("[id='" + filterType + "ProfessionChoiceRow']").animate({marginTop: "0px", height: "30px"}, browseAnimateSpeed, function(){});
            }else if(toggleType === "shrink"){
                $("[id='" + filterType + "ProfessionChoiceRow']").animate({marginTop: "0px", height: "0px"}, browseAnimateSpeed, function(){});
            }
        }
    }*/

    function getAnimationHeights(addFilterPanelHeight, addFilteredProfessions){
        var heightsDict = {}
        var searchPanelBaseHeight = 180;
        if(addFilterPanelHeight){
            searchPanelBaseHeight += 40;
        }


        var browseResultsHeight = getBrowseResultsTableHeight()

        var filterPanelHeight = 0;
        for(var i=0; i < activeTabs.length; i++){
            filterPanelHeight += filterSectionHeights[activeTabs[i]];
        }

        // Browse content is search panel + search results
        heightsDict["browseContent"] = searchPanelBaseHeight;
        if(!firstSearch){
            heightsDict["browseContent"] += browseResultsHeight;
        }

        heightsDict["searchPanel"] = searchPanelBaseHeight;

        heightsDict["searchResultsPanel"] = searchPanelBaseHeight;  // Top, not height

        heightsDict["browseFiltersPanel"] = 40;

        for(divID in heightsDict){
            if(addFilterPanelHeight){
                heightsDict[divID] += filterPanelHeight;
            }
            if(addFilteredProfessions){
                heightsDict[divID] += Math.max((filteredProfessions.length - 1), 0) * professionRowHeight;
            }
        }
        return heightsDict
    }

    function animateBrowsePanelHeights(addFilterPanelHeight, addFilteredProfessions, animationFinishCallbacks){
        if(animationFinishCallbacks == null){
            animationFinishCallbacks = {};
        }

        var heights = getAnimationHeights(addFilterPanelHeight, addFilteredProfessions)
        var panelList = ["browseContent", "searchPanel", "browseFiltersPanel"];
        for(var i=0; i < panelList.length; i++){
            $("[id='" + panelList[i] + "']").animate({marginTop: "0px", height: heights[panelList[i]] + "px"}, browseAnimateSpeed, function(){
                var panelName = $(this).attr('id')
                if(panelName in animationFinishCallbacks && animationFinishCallbacks[panelName] != null){
                    animationFinishCallbacks[panelName]();
                }
            });

            // Animating sets overflow to hidden during animation, so set it manually to fix
            if(panelList[i] === "browseContent"){
                document.getElementById("browseContent").style.overflow = "visible"
            }
        }

        // Special case: need to modify top of search results panel, not height
        $("#searchResultsPanel").animate({top: heights["searchResultsPanel"] + "px"}, browseAnimateSpeed, function(){
                var panelName = $(this).attr('id')
                if(panelName in animationFinishCallbacks && animationFinishCallbacks[panelName] != null){
                    animationFinishCallbacks[panelName]();
                }
        });
    }

    var professionRowHeight = 29;
    function displayFilteredProfessions(filterType, forceUpdate){
        var row = document.getElementById(filterType + "ProfessionChoiceRow");
        if(row != null){
            var professionString = ''
            if(filteredProfessions.length > 0){
                professionString = "<ul class='filteredProfessionList browseFilterListElement left'>"
                for(var i=0; i < filteredProfessions.length; i++){
                    professionString += "<li style='margin-bottom: 3px; text-align: left; position: relative;'><div style='position: absolute; left: 5px;'>" + filteredProfessions[i] + "</div><a onclick='removeFilteredProfession(" + '"' + filteredProfessions[i] + '");' + "' style='font-size: 1em; font-weight: 800; position: absolute; right: 5px;'>X</a></li>";
                }
                professionString += "</ul>"
            }else{
                professionString += ""
            }

            row.innerHTML = professionString;

            // Special case: single profession needs to moved up 3px to look properly centered
            var rowMarginTop = -1;
            var expandParentContainers = true;
            if(filteredProfessions.length <= 1){
                rowMarginTop = -4;
                expandParentContainers = false
            }
            $("[id='" + filterType + "ProfessionChoiceRow']").animate({marginTop: rowMarginTop + "px", height: Math.max(filteredProfessions.length * professionRowHeight, 4) + "px"}, browseAnimateSpeed, function(){});
            if(expandParentContainers || forceUpdate){
                // Update the height of the container row so filter panels below this one will expand
                $("[id='" + filterType + "FilterRow']").animate({marginTop: "0px", height: filterSectionHeights[filterType] + ((filteredProfessions.length-1) * professionRowHeight) + "px"}, browseAnimateSpeed, function(){});
                animateBrowsePanelHeights(true, true)
            }
        }
    }

    var filteredProfessions = []
    function removeFilteredProfession(profession){
        var professionIndex = filteredProfessions.indexOf(profession)
        if(professionIndex > -1){
            filteredProfessions.splice(professionIndex, 1)
        }

        // Update the select value if its current value is being removed (either to default or last chosen)
        var professionSelect = document.getElementById("jobsProfessionSelect")
        if(professionSelect != null){
            if(filteredProfessions.length > 0){
                professionSelect.value = filteredProfessions[filteredProfessions.length - 1];
            }else{
                professionSelect.value = defaultSelectValues["professions"];
            }
        }

        // Special case, want to force panel to shrink if there were 2 professions and 1 was removed,
        // normally wouldn't update if there was only 1 element
        var forceUpdate = true;
        if(filteredProfessions.length === 0){
            forceUpdate = false;
        }
        displayFilteredProfessions("jobs", forceUpdate)
    }
    var defaultSelectValues = {"professions": "-", "status": "-", "compensation": "-", "roleType": "-", "gender": "-", "ageRange": "-", "build": "-", "hairColor": "-", "eyeColor": "-", "ethnicity": "-"}
    function getJobsFilters(){
        var filterString = '';
        var filterCallbacks = [];
        {% if browseFilters and browseFilters.jobs %}
            filterString += "<div style='height: 100%; text-align: left; position: relative;'>";

            // Add header
            filterString += "<div style='position: absolute; top: 0; left: 10px;'><h3>Jobs</h3></div>"


            // Add left list
            filterString += "<div style='position: absolute; top: 27px; left: 10px; right: 50%;'><ul class='browseFilterList'>"

            // Add status
            filterString += "<li><div class='browseFilterListLabel left'>Status: </div>"
            {% if browseFilters.jobs.statusList %}
                var statusList = {{browseFilters.jobs.statusList|safe}}
                statusList.unshift(defaultSelectValues["status"])
                filterString += "<div class='browseFilterListElement left'>" + createSelectForm("jobsFiltersForm", "jobsStatusSelect", statusList, defaultSelectValues["status"]) + "</div>"
            {% endif %}
            filterString += "</li>"

            // Add profession
            filterString += "<li><div class='browseFilterListLabel left'>Profession: </div>";
            {% if browseFilters.jobs.professionList %}
                var professions = {{browseFilters.jobs.professionList|safe}}
                professions.unshift(defaultSelectValues["professions"])     // Add to front of list
                filterString += "<div class='browseFilterListElement left'>" + createSelectForm("jobsFiltersForm", "jobsProfessionSelect", professions, defaultSelectValues["professions"]) + "</div>"
            {% endif %}
            filterString += "</li>";

            // Add profession choices
            filterString += "<li id='jobsProfessionChoiceRow' style='height: 0px;'></li>";
            filterCallbacks.push(function(){
                var professionSelect = document.getElementById("jobsProfessionSelect");
                if(professionSelect != null){
                    $("#jobsProfessionSelect").change(function(){
                        /*if(filteredProfessions.length === 0){
                            toggleProfessionChoiceRow("expand", "jobs");
                        }*/
                        if(professionSelect.value != defaultSelectValues["professions"]){
                            filteredProfessions.push(professionSelect.value)
                            displayFilteredProfessions("jobs")
                        }
                    })
                }
            })
            filterString += "</ul></div>"


            // Add right list
            filterString += "<div style='position: absolute; top: 27px; left: 48%; right: 0;'><ul class='browseFilterList'>"

            // Add compensation
            filterString += "<li><div class='browseFilterListLabel right'>Compensation: </div>"
            {% if browseFilters.jobs.compensationList %}
                var compensationTypes = {{browseFilters.jobs.compensationList|safe}};
                compensationTypes.unshift(defaultSelectValues["compensation"])
                filterString += "<div class='browseFilterListElement right'>" + createSelectForm("jobsFiltersForm", "jobsCompensationSelect", compensationTypes, defaultSelectValues["compensation"]) + "</div>";
            {% endif %}
            filterString += "</li>";

            // Add dates
            // Can use below list item that has 1 label of dates with the 2 inputs on separate lines
            /*filterString += "<li style='height: 50px;'> Dates: <ul style='height: 50px;  width: 120px; margin-top: -20px; margin-left: 50px;'><li><input type='date' value='" + currentDateString + "' style=''></li><li><input type='date' value='" + tomorrowDateString + "'></li></ul></li>"*/
            filterString += "<li><div class='browseFilterListLabel right'>Start date: </div><div class='browseFilterListElement right'><input type='date' id='jobsStartDate' value='' style=''></div></li>"
            filterString += "<li><div class='browseFilterListLabel right'>End date: </div><div class='browseFilterListElement right'><input type='date' id='jobsEndDate' value='' style=''></div></li>"

            filterString += "</ul></div>"

            // Add search button
            filterString += ""
        {% endif %}
        return {"html": filterString, "callbacks": filterCallbacks}
    }

    function getRolesFiltersString(){
        var filterString = '';
        var filterCallbacks = [];
        {% if browseFilters and browseFilters.roles %}
            filterString += "<div style='height: 100%; text-align: left; position: relative;'>";

            // Add header
            filterString += "<div style='position: absolute; top: 0; left: 10px;'><h3>Roles</h3></div>"


            // Add left list
            filterString += "<div style='position: absolute; top: 27px; left: 10px; right: 50%;'><ul class='browseFilterList'>"

            /*// Add profession
            filterString += "<li><div class='browseFilterListLabel left'>Profession: </div>";
            {% if browseFilters.roles.professionList %}
                var professions = {{browseFilters.roles.professionList|safe}}
                professions.unshift(defaultSelectValues["professions"])     // Add to front of list
                filterString += "<div class='browseFilterListElement left'>" + createSelectForm("rolesFiltersForm", "rolesProfessionSelect", professions, defaultSelectValues["professions"]) + "</div>"
            {% endif %}
            filterString += "</li>";

            // Add profession choices
            filterString += "<li id='jobsProfessionChoiceRow' style='height: 0px;'></li>";
            filterCallbacks.push(function(){
                var professionSelect = document.getElementById("jobsProfessionSelect");
                if(professionSelect != null){
                    $("#jobsProfessionSelect").change(function(){
                        if(professionSelect.value != defaultSelectValues["professions"]){
                            filteredProfessions.push(professionSelect.value)
                            displayFilteredProfessions("jobs")
                        }
                    })
                }
            })*/

            // Add status
            filterString += "<li><div class='browseFilterListLabel left'>Status: </div>"
            {% if browseFilters.roles.statusList %}
                var statusList = {{browseFilters.roles.statusList|safe}}
                statusList.unshift(defaultSelectValues["status"])       // have to add default status '-' as it is not in statusList
                filterString += "<div class='browseFilterListElement left'>" + createSelectForm("rolesFiltersForm", "rolesStatusSelect", statusList, defaultSelectValues["status"]) + "</div>"
            {% endif %}
            filterString += "</li>"

            // Add role type
            filterString += "<li><div class='browseFilterListLabel left'>Type: </div>"
            {% if browseFilters.roles.roleTypeList %}
                var roleTypeList = {{browseFilters.roles.roleTypeList|safe}}
                roleTypeList.unshift(defaultSelectValues["roleType"])       // have to add default status '-' as it is not in roleTypeList

                filterString += "<div class='browseFilterListElement left'>" + createSelectForm("rolesFiltersForm", "rolesTypeSelect", roleTypeList, defaultSelectValues["roleType"]) + "</div>"
            {% endif %}
            filterString += "</li>"

            // Add gender
            filterString += "<li><div class='browseFilterListLabel left'>Gender: </div>"
            {% if browseFilters.roles.genderList %}
                var genderList = {{browseFilters.roles.genderList|safe}}
                filterString += "<div class='browseFilterListElement left'>" + createSelectForm("rolesFiltersForm", "rolesGenderSelect", genderList, defaultSelectValues["gender"]) + "</div>"
            {% endif %}
            filterString += "</li>"

            // Add age range
            filterString += "<li><div class='browseFilterListLabel left'>Age range: </div>"
            {% if browseFilters.roles.ageRangeList %}
                var ageRangeList = {{browseFilters.roles.ageRangeList|safe}}
                filterString += "<div class='browseFilterListElement left'>" + createSelectForm("rolesFiltersForm", "rolesAgeRangeSelect", ageRangeList, defaultSelectValues["ageRange"]) + "</div>"
            {% endif %}

            // Add build
            filterString += "<li><div class='browseFilterListLabel left'>Build: </div>"
            {% if browseFilters.roles.ageRangeList %}
                var buildList = {{browseFilters.roles.buildList|safe}}
                filterString += "<div class='browseFilterListElement left'>" + createSelectForm("rolesFiltersForm", "rolesBuildSelect", buildList, defaultSelectValues["build"]) + "</div>"
            {% endif %}
            filterString += "</li>"


            filterString += "</ul></div>"


            // Add right list
            filterString += "<div style='position: absolute; top: 27px; left: 48%; right: 0;'><ul class='browseFilterList'>"

            // Add compensation
            filterString += "<li><div class='browseFilterListLabel right'>Compensation: </div>"
            {% if browseFilters.roles.compensationList %}
                var compensationTypes = {{browseFilters.roles.compensationList|safe}};
                compensationTypes.unshift(defaultSelectValues["compensation"])
                filterString += "<div class='browseFilterListElement right'>" + createSelectForm("rolesFiltersForm", "rolesCompensationSelect", compensationTypes, defaultSelectValues["compensation"]) + "</div>";
            {% endif %}
            filterString += "</li>";

            // Add dates
            // Can use below list item that has 1 label of dates with the 2 inputs on separate lines
            /*filterString += "<li style='height: 50px;'> Dates: <ul style='height: 50px;  width: 120px; margin-top: -20px; margin-left: 50px;'><li><input type='date' value='" + currentDateString + "' style=''></li><li><input type='date' value='" + tomorrowDateString + "'></li></ul></li>"*/
            filterString += "<li><div class='browseFilterListLabel right'>Start date: </div><div class='browseFilterListElement right'><input type='date' id='rolesStartDate' value='' style=''></div></li>"
            filterString += "<li><div class='browseFilterListLabel right'>End date: </div><div class='browseFilterListElement right'><input type='date' id='rolesEndDate' value='' style=''></div></li>"

            // Add hair color
            filterString += "<li><div class='browseFilterListLabel right'>Hair color: </div>"
            {% if browseFilters.roles.hairColorList %}
                var hairColorTypes = {{browseFilters.roles.hairColorList|safe}};
                filterString += "<div class='browseFilterListElement right'>" + createSelectForm("rolesFiltersForm", "rolesHairColorSelect", hairColorTypes, defaultSelectValues["hairColor"]) + "</div>";
            {% endif %}

            // Add eye color
            filterString += "<li><div class='browseFilterListLabel right'>Eye color: </div>"
            {% if browseFilters.roles.eyeColorList %}
                var eyeColorTypes = {{browseFilters.roles.eyeColorList|safe}};
                filterString += "<div class='browseFilterListElement right'>" + createSelectForm("rolesFiltersForm", "rolesEyeColorSelect", eyeColorTypes, defaultSelectValues["eyeColor"]) + "</div>";
            {% endif %}
            filterString += "</li>";

            // Add ethnicity
            filterString += "<li><div class='browseFilterListLabel right'>Ethnicity: </div>"
            {% if browseFilters.roles.ethnicityList %}
                var ethnicityTypes = {{browseFilters.roles.ethnicityList|safe}};
                filterString += "<div class='browseFilterListElement right'>" + createSelectForm("rolesFiltersForm", "rolesEthnicitySelect", ethnicityTypes, defaultSelectValues["ethnicity"]) + "</div>";
            {% endif %}
            filterString += "</li>";

            filterString += "</div>"
        {% endif %}
        return {"html": filterString, "callbacks": filterCallbacks}
    }

    function getUsersFiltersString(){
        return "User filters"
    }

    function getProjectsFiltersString(){
        return "project filters"
    }

    function getEventsFiltersString(){
        return "Event filters"
    }

    function toggleExpandBrowseFiltersPanel(expandType){
        var filterPanelHeight = filterSectionHeights[expandType] * activeTabs.length;
        var browseResultsHeight = getBrowseResultsTableHeight()
        if(firstSearch){
            // Special case when first loading filters
            browseResultsHeight -= 58;
        }

        var searchPanel = document.getElementById("searchPanel");
        var filterContent = document.getElementById("browseFiltersPanelContent")
        var addFiltersButton = document.getElementById("addFiltersButton");
        var updateSearchButton = document.getElementById("updateSearchButton");
        if(searchPanel != null && filterContent != null && addFiltersButton != null && updateSearchButton != null){
            if(expandType === "expand"){
                filterContent.style.display = "block";
                updateSearchButton.style.display = "block";
                var filterPanelInfo = createFilterPanel();
                filterContent.innerHTML = filterPanelInfo["html"]
                if(filterPanelInfo["callbacks"].length > 0){
                    for(var i=0; i < filterPanelInfo["callbacks"].length; i++){
                        filterPanelInfo["callbacks"][i]();
                    }
                }
                addFiltersButton.innerHTML = "Hide"
                addFiltersButton.onclick = function(){toggleExpandBrowseFiltersPanel("shrink")}
                animateBrowsePanelHeights(true, false, {});
            }else if(expandType === "shrink"){
                addFiltersButton.innerHTML = "Advanced search"
                addFiltersButton.onclick = function(){toggleExpandBrowseFiltersPanel("expand");}
                var finishCallback = function(){
                    updateSearchButton.style.display = "none";
                    filterContent.style.display = "none";
                    filterContent.innerHTML = '';
                    filteredProfessions = [];
                }
                animateBrowsePanelHeights(false, false, {"browseFiltersPanel": finishCallback})
                
            }
        }
    }
</script>


<div id='backgroundPanel' class='backgroundPanel' style='min-width: 600px; min-height: 100%;'>
    <div id="mainViewPanel" class="mainViewPanel" style="position: relative; min-width: 600px; max-width: 600px; background: rgba(0,0,0,0.05); border: none; margin-top: 10%;">
        <div id='browseContent' style='display: block; position: relative; height: 180px; width: 100%;'>
            <div id='searchPanel' class='browseSearchPanel' style='position: absolute; height: 180px; left: 0; right: 0; z-index: 1;'>
                <div id='searchPanelContent' style='position: relative; height: 100%; width: 100%;'>
                    <h1 style='margin-top: 10px;'>Explore</h1>
                    <div class='browseSearchTextBoxContainer' style='position:absolute; top: 50px; width: 420px; margin: 0 auto; left: 0; right: 0;'>
                        <div style='position: relative;'>
                            <div style='position: absolute; left: 0; right: 80px;'>
                                <input type='text' id='searchTextInput' placeholder='Add search keywords'>
                                <div id="browseDropdown" class="previewDropdownPanel" style="position: absolute; left: 0; right: 0; margin-right: -5px; top: 35px; border: 1px solid #86898e; display: none;">
                                </div>

                                <script>
                                    addBrowseDropdownCallback("searchPreviewBrowseSuggestions", "submitSearchButton", {})
                                </script>
                            </div>
                            <div onclick='submitSearch();' id='submitSearchButton' style='position: absolute; right: -4px; padding: 5px 10px; margin-top: 7px; font-size: 0.9em;' class='whiteButton blackHover'>
                                Search
                            </div>
                        </div>
                    </div>
                    <div class="browseCategoriesList" style="position: absolute; top: 87px; margin: 0 auto; left: 0; right: 0;">
                        <ul style='margin-top: 10px;'>
                            <script>
                                for(var i=0; i<browseTabs.length; i++){
                                    var categoryButtonString = "<li ";
                                    /*if(i === 0){
                                        categoryButtonString += "class='active' "
                                    }*/
                                    categoryButtonString += "id='" + browseTabs[i] + "BrowseCategoryButton' onclick='selectBrowseTab(" + '"' + browseTabs[i] + '");' + "'>" + browseTabs[i].toUpperCase() + "</li>";
                                    document.write(categoryButtonString)
                                }
                            </script>
                        </ul>
                    </div>
                    <div id='browseFilterButtonContainer' style='position: absolute; top: 140px; left: 10px;'>
                        <a id='addFiltersButton' onclick='toggleExpandBrowseFiltersPanel("expand");'>Advanced search</a>
                    </div>
                    <div id='browseFiltersPanel' style='position: absolute; top: 170px; left: 0; right: 0; height: 0px; margin-top: 0px; overflow: hidden;'>
                        <div style='position: relative; height: 100%;'>
                            <div id='browseFiltersPanelContent' style='display: none;'>
                            </div>
                            <div id='updateSearchButton' style='position: absolute; right: 10px; bottom: 10px; padding: 5px 10px; font-size: 0.85em; display: none;' class='whiteButton blackHover' onclick='submitSearch();'>Update search</div>
                        </div>
                    </div>


                </div>
            </div>
            <div id='searchResultsPanel' class='browseSearchResults' style='position: absolute; left: 0; right: -2px; margin-top: 10px; top: 180px; display: none;'></div>
        </div>
    </div>
</div>

<script>
// Replace the search result table on load.
var mainView = document.getElementById("mainViewPanel")
var clickDefaultCategory = true;
if (('localStorage' in window) && window['localStorage'] !== null) {
    if('activeTabs' in localStorage && localStorage.getItem('activeTabs') != ''){
        if(document.getElementById("searchTextInput").value != ''){
            var previousActiveTabs = JSON.parse(localStorage.getItem('activeTabs'));
            if(previousActiveTabs != null && previousActiveTabs.length > 0){
                clickDefaultCategory = false;
                for(var i=0; i < previousActiveTabs.length; i++){
                    $('[id="' + previousActiveTabs[i] + 'BrowseCategoryButton"]').click()
                }
                localStorage.setItem("activeTabs", "")
            }
        }
    }

    if ('loadSearch' in localStorage && localStorage.getItem('loadSearch') === "true") {
        if(document.getElementById("searchTextInput").value != ''){
            // Search value is filled when presseing back button, so can just resubmit
            submitSearch()
            localStorage.setItem('loadSearch', 'false')
        }

    }
}

if(clickDefaultCategory){
    $("#jobsBrowseCategoryButton").click();
}

// Save the search result table when leaving the page.
$(window).on("unload", function (e) {
    if (('localStorage' in window) && window['localStorage'] !== null) {
        localStorage.setItem('activeTabs', JSON.stringify(activeTabs))
        localStorage.setItem('loadSearch', 'true');
    }
});
</script>

<!--<script>
    function search(){
        var searchInput = document.getElementById("searchInput");
        if(searchInput != null){
            var searchValue = searchInput.value;
            console.log(searchValue);
        }
    }

</script>

<div id="searchBar">
    <div id="searchOptions"></div>
        <ul>
            <li id="searchOptions.post"><a href="/browse/posts/">Posts</a></li>
            <li id="searchOptions.project"><a href="/browse/projects/">Projects</a></li>
            <li id="searchOptions.event"><a href="/browse/events/">Events</a></li>
            <li id="searchOptions.user"><a href="/browse/users/">Users</a></li>
        </ul>
        <br>
        <div id="secondSearchOptions">
            <div id="postSearchOptions" style="display:none">
                <ul>
                    <li id="secondSearchOptions.casting"><a onclick='filterPosts("casting");'>Casting</a></li>
                    <li id="secondSearchOptions.work"><a onclick='filterPosts("work");'>Set Work</a></li>
                    <li id="secondSearchOptions.collaboration"><a onclick='filterPosts("collaboration");'>Collaboration</a></li>
                </ul>
            </div>
            <div id="userSearchOptions" style="display:none">
                <ul>
                    <li id="secondSearchOptions.actors"><a onclick='filterUsers("actors");'>Actors</a></li>
                    <li id="secondSearchOptions.workers"><a onclick='filterUsers("workers");'>On-set Workers</a></li>
                    <li id="secondSearchOptions.other"><a onclick='filterUsers("other");'>Other</a></li>

                </ul>
            </div>
        </div>
    </div>
    <br>
    <input type="text" placeholder="Search" name="searchInput" id="searchInput" />
    <button onclick="search()"> Search</button>
    <br><br>
</div>
9
<div id="eventsViewDiv"></div>
<div id="projectsViewDiv"></div>
<div id="postsViewDiv"></div>
<div id="usersViewDiv"></div>
<br>
<div id="cancelButton" class="button"><div id="cancelButtonLabel"></div></div>
<div id="browseCancelButton" class="button"><div id="cancelButtonLabel"></div></div>

{% if source == possibleDestinations.viewPost %}
    <script>
    $(document).ready(function(){
        var cancelButtonDiv2 = document.getElementById("browseCancelButton");
        var cancelButton2 = createCancelButton(cancelButtonDiv2, "{{ possibleDestinations.browse }}", "{{ currentPageURL }}", "Back to browse")
    });
    </script>
{% endif %}

<!-<div id="collabViewDiv"></div>
<div id="workViewDiv"></div>
<div id="castingViewDiv"></div>!->

<script>/* TODO use this function when I have internet to fio how to pass django objects to a functino
    function addPostPictureColumn(post){
        // Add empty column even if a pic exists
        var colString = '<td>';
        {% if post.postPicture %}
            colString += '<img src="' + post.postPicture.url + '" height="50px" width="70px"/>'
        {% else %}
            //TODO add a default pic
            console.log(picURL)
            colString += '<img height="50px" width="70px"/>'
        {% endif %}
        colString += '</td>';
        return colString
    }*/

    /* TODO figure out how to make ajax call blocking when I get internet
    function getFollowingCol(postID){
        var followingCol = null;
        $.ajax({
            url : "/ajax/getPostFollowingBool/",
            data : {"postID": postID},
            type : 'POST',
            dataType: "json",
            success : function(data) {
                followingCol += "<td>"
                console.log("1. followingCol is " + followingCol);

                if(data["following"]){
                    followingCol += "&#10004";
                }
                followingCol += "</td>";
            }
        });
        return followingCol
    }*/
    var posterNameMap = {{ posterNameMap|safe }};


    function getFollowingCol(postID){
        var colString = "<td>";
        {% for followingPostID in followingPostIDs %}
            if(postID == "{{followingPostID}}"){
                colString += "&#10004";
                //TODO add django for loop break
            }
        {% endfor %}
        colString += "</td>";
        return colString
    }

    function createViewEventsTable(){
        var tableString = '<h3>Browse events</h3>';
        {% if events %}
            tableString += '<table class="browseTable">';
            tableString += ("<tr> " +
                                "<td></td>" +  //post picture
                                "<td> Title </td>" +
                                "<td> Posted by </td>" +
                                "<td> Date </td>" +
                                "<td> Location </td>" +
                                "<td> Description </td>" +
                                "<td> Following </td>" +    // TODO don't add following column if user is not logged in
                            "</tr>");

            //Add each event

            {% for eventObj in events %}
                var picURL = null;
                {% if eventObj.postPicture %}
                    picURL = "{{ eventObj.postPicture.url }}"
                {% endif %}
                tableString += ("<tr>" + getPictureCol(picURL, "browseImage") +
                                    "<td><button onclick='createPostRedirectForm(" + '"{{eventObj.postID}}","{{possibleDestinations.viewPost}}"' + ");'>{{eventObj.title}}</button></td>" +
                                    "<td><div id='" + getNextProfileName() + "'>{{eventObj.poster}}</td>" +
                                    "<td>{{eventObj.date}}</td>" +
                                    "<td>{{eventObj.location}}</td>" +
                                    "<td>{{eventObj.description}}</td>" + getFollowingCol("{{eventObj.postID}}") + 
                                "</tr>");
            {% endfor %}
            tableString += "</table>";
        {% endif %}
        return tableString;
    };

    function createViewProjectsTable(){
        var tableString = '<h3>Browse projects</h3>';
        {% if projects %}
            tableString += '<table class="browseTable">';
            tableString += ("<tr><td></td>" +
                                "<td> Title </td>" +
                                "<td> Posted by </td>" +
                                "<td> Status </td>" +
                                "<td> Description </td>" +
                                "<td> Following </td>" +
                            "</tr>");

            //Add each event
            {% for projectObj in projects %}
                var picURL = null;
                {% if projectObj.postPicture %}
                    picURL = "{{ projectObj.postPicture.url }}"
                {% endif %}
                tableString += ("<tr>" + getPictureCol(picURL, "browseImage") +
                                    "<td><button onclick='createPostRedirectForm(" + '"{{projectObj.postID}}","{{possibleDestinations.viewPost}}"' + ");'>{{projectObj.title}}</button></td>" +
                                        "<td><div id='" + getNextProfileName() + "'>{{projectObj.poster}}</td>" +
                                    "<td>{{projectObj.status}}</td>" +
                                    "<td>{{projectObj.description}}</td>" + getFollowingCol("{{projectObj.postID}}") +
                                "</tr>");

            {% endfor %}
            tableString += "</table>";
        {% endif %}
        return tableString;
    };

    function createViewUsersTable(userType){
        var tableTitle = "<h3> Browse users</h3>"
        var userList = [];
        if(userType === "actors"){
            tableTitle = "<h3> Browse actors</h3>"
            {% for actor in actors %}
                var actorObj = {username: "{{actor.username}}",
                                profilePictureURL: null};
                {% if actor.profilePicture %}
                    actorObj["profilePictureURL"] = "{{actor.profilePicture.url}}";
                {% endif %}
                userList.push(actorObj)
            {% endfor %}
        }else if(userType === "workers"){
            tableTitle = "<h3> Browse on-set workers</h3>"
            {% for worker in workers %}
                var workerObj = {username: "{{worker.username}}",
                                 profilePictureURL: null};
                {% if worker.profilePicture %}
                    workerObj["profilePictureURL"] = "{{worker.profilePicture.url}}";
                {% endif %}
                userList.push(workerObj)
            {% endfor %}
        }else{
            tableTitle = "<h3> Browse other amateur and professional filmmakers</h3>"
            {% for user in other %}
                var userObj = {username: "{{user.username}}",
                               profilePictureURL: null};
                {% if user.profilePicture %}
                    userObj["profilePictureURL"] = "{{user.profilePicture.url}}";
                {% endif %}
                userList.push(userObj)
            {% endfor %}
        }

        var tableString = tableTitle;
        if(userList.length > 0){
            tableString += '<table class="browseTable">';
            tableString += ("<tr><td></td>" +
                                "<td> Name </td>" +
                                "<td> Professions </td>" +
                            "</tr>");

            var posterNameMap = {{ posterNameMap|safe }};
            if(userList != null){
                for(var i=0; i < userList.length; i++){
                    var userObj = userList[i];
                    
                    var professionCol = "<td>";
                    {% if posterProfessionMap %}
                        var posterProfessionMap = {{ posterProfessionMap|safe }};
                        professionCol += posterProfessionMap[userObj["username"]];
                    {% endif %}
                    professionCol += "</td>";
                    var newRow = ("<tr>" + getPictureCol(userObj["profilePictureURL"], "browseImage") + "<td><button onclick='createProfileRedirectForm(" + '"' + userObj["username"] + '");' + "'>" + posterNameMap[userObj["username"]] + "</button></td>" + professionCol + "</tr>");
                    tableString += newRow;
                }
            }
        }
        tableString += "</table>";
        return tableString;
    };

    function getPictureCol(sourceURL, className){
        pictureCol = "<td>"
        if(sourceURL != null && sourceURL != ""){
            pictureCol += '<img class="' + className + '" width="150px" src="' + sourceURL + '" />';
        }else{
            pictureCol += '<img class="' + className + '" width="150px" height="150px">';
        }
        pictureCol += "</td>";
        return pictureCol;
    }

    function createViewCollabPostTable(){
        var tableString = '<h3>Browse posts seeking collaborators</h3>';
        {% if posts.collaboration %}
            tableString += '<table class="browseTable">';
            tableString += ("<tr><td></td>" +
                                "<td> Title </td>" +
                                "<td> Posted by </td>" +
                                "<td> Seeking </td>" +
                                "<td> Description </td>" +
                                "<td> Following </td>" +
                            "</tr>");

            //Add each event
            {% for collabObj in posts.collaboration %}
                var picURL = null;
                {% if collabObj.postPicture %}
                    picURL = "{{ collabObj.postPicture.url }}"
                {% endif %}
                tableString += ("<tr>" + getPictureCol(picURL, "browseImage") +
                                    "<td><button onclick='createPostRedirectForm(" + '"{{collabObj.postID}}","{{possibleDestinations.viewPost}}"' + ");'>{{collabObj.title}}</button></td>" +
                                    "<td><div id='" + getNextProfileName() + "'>{{collabObj.poster}}</td>" +
                                    "<td>{{collabObj.collaboratorRole}}</td>" +
                                    "<td>{{collabObj.description}}</td>" + getFollowingCol("{{collabObj.postID}}") +
                                "</tr>");

            {% endfor %}
            tableString += "</table>";
        {% endif %}
        return tableString;
    };


    function createViewWorkPostTable(){
        var tableString = '<h3>Browse posts seeking crew members</h3>';
        {% if posts.work %}
            tableString += '<table class="browseTable">';
            tableString += ("<tr><td></td>" +
                                "<td> Title </td>" +
                                "<td> Posted by </td>" +
                                "<td> Seeking </td>" +
                                "<td> Description </td>" +
                                "<td> Paid </td>" +
                                "<td> Following </td>" +
                            "</tr>");

            //Add each event
            {% for workObj in posts.work %}
                var picURL = null;
                {% if workObj.postPicture %}
                    picURL = "{{ workObj.postPicture.url }}"
                {% endif %}
                tableString += ("<tr>" + getPictureCol(picURL, "browseImage") +
                                    "<td><button onclick='createPostRedirectForm(" + '"{{workObj.postID}}","{{possibleDestinations.viewPost}}"' + ");'>{{workObj.title}}</button></td>" +
                                    "<td><div id='" + getNextProfileName() + "'>{{workObj.poster}}</td>" +
                                    "<td>{{workObj.profession}}</td>" +
                                    "<td>{{workObj.description}}</td>")
                
                // Add tick or x for paid
                {% if workObj.paid %}
                    tableString += "<td>&#10004;</td>";
                {% else %}
                    tableString += "<td></td>";
                {% endif %}
                tableString += getFollowingCol("{{workObj.postID}}");
                tableString += "</tr>";
            {% endfor %}
            tableString += "</table>";
        {% endif %}
        return tableString;
    };

    function createViewCastingPostTable(){
        var tableString = '<h3>Browse casting posts</h3>';
        {% if posts.casting %}
            tableString += '<table class="browseTable">';
            tableString += ("<tr><td></td>" +
                                "<td> Title </td>" +
                                "<td> Posted by </td>" +
                                "<td> Description </td>" +
                                "<td> Paid </td>" +
                                "<td> Following </td>" +
                            "</tr>");

            //Add each event
            {% for castingObj in posts.casting %}
                var picURL = null;
                {% if castingObj.postPicture %}
                    picURL = "{{ castingObj.postPicture.url }}"
                {% endif %}
                tableString += ("<tr>" + getPictureCol(picURL, "browseImage") +
                                    "<td><button onclick='createPostRedirectForm(" + '"{{castingObj.postID}}","{{possibleDestinations.viewPost}}"' + ");'>{{castingObj.title}}</button></td>" +
                                    "<td><div id='" + getNextProfileName() + "'>{{castingObj.poster}}</td>" +
                                    "<td>{{castingObj.description}}</td>")
                
                // Add tick or x for paid
                {% if castingObj.paid %}
                    tableString += "<td>&#10004;</td>";
                {% else %}
                    tableString += "<td></td>";
                {% endif %}
                tableString += getFollowingCol("{{castingObj.postID}}");
                tableString += "</tr>";
            {% endfor %}
            tableString += "</table>";
        {% endif %}
        return tableString;
    };

    function createPostRedirectForm(postID, destinationPageName){
        //Create a dict with the postID
        var extraInputs = []
        extraInputs.push({key: "postID", value: postID});
        var form = createPageRedirectForm("{{ next }}", "{{ next }}", destinationPageName, "{{ currentPageURL }}", extraInputs);
        form.submit();
    }

    function createProfileRedirectForm(username){
        var extraInputs = []
        extraInputs.push({key: "profileName", value: username});
        var form = createPageRedirectForm("{{ next }}", "{{ next }}", "{{ possibleDestinations.profile }}", "{{ currentPageURL }}", extraInputs);
        form.submit();
    }

    function displayEvents(){
        document.getElementById("searchOptions.event").className = "active";
        {% if events %}
            document.getElementById("eventsViewDiv").innerHTML = createViewEventsTable();
        {% else %}
            document.getElementById("eventsViewDiv").innerHTML = "<h3> No events posted </h3>";
        {% endif %}
    }

    function displayPosts(){
        secondSearchOptions = document.getElementById("postSearchOptions");
        if(secondSearchOptions != null){
            secondSearchOptions.style.display = "block";
            document.getElementById("secondSearchOptions.work").className = "active";
            document.getElementById("searchOptions.post").className = "active";
            filterPosts("casting");
        }
    }

    function filterPosts(postType){
        var postDivHTML = "";
        document.getElementById("secondSearchOptions.casting").className = "";
        document.getElementById("secondSearchOptions.work").className = "";
        document.getElementById("secondSearchOptions.collaboration").className = "";
        if(postType === "casting"){
            document.getElementById("secondSearchOptions.casting").className = "active";
            {% if posts.casting %}
                postDivHTML += createViewCastingPostTable();
            {% else %}
                postDivHTML +="<h3> No casting ads posted</h3>";
            {% endif %}
        }else if(postType === "work"){
            document.getElementById("secondSearchOptions.work").className = "active";
            {% if posts.work %}
                postDivHTML += createViewWorkPostTable();
            {% else %}
                postDivHTML +="<h3> No work ads posted</h3>";
            {% endif %}
        }else if(postType === "collaboration"){
            document.getElementById("secondSearchOptions.collaboration").className = "active";
            {% if posts.collaboration %}
                postDivHTML += createViewCollabPostTable();
            {% else %}
                postDivHTML +="<h3> No collaboration ads posted</h3>";
            {% endif %}
        }
        document.getElementById("postsViewDiv").innerHTML = postDivHTML;
    }

    function displayUsers(){
        secondSearchOptions = document.getElementById("userSearchOptions");
        if(secondSearchOptions != null){
            secondSearchOptions.style.display = "block";
            document.getElementById("searchOptions.user").className = "active";
            filterUsers("actors");
        }
    }

    function filterUsers(userType){
        var postDivHTML = "";
        document.getElementById("secondSearchOptions.actors").className = "";
        document.getElementById("secondSearchOptions.workers").className = "";
        document.getElementById("secondSearchOptions.other").className = "";
        if(userType === "actors"){
            document.getElementById("secondSearchOptions.actors").className = "active";
        }else if(userType === "workers"){
            document.getElementById("secondSearchOptions.workers").className = "active";
        }else{
            document.getElementById("secondSearchOptions.other").className = "active";
        }

        {% if posterNameMap %}
            var userTable = createViewUsersTable(userType);
            document.getElementById("usersViewDiv").innerHTML = userTable;
        {% else %}
            document.getElementById("usersViewDiv").innerHTML = "<h3> No users registered</h3>";
        {% endif %}
    }

    $(document).ready(function(){
        if("{{browseType}}" == "{{possibleViews.events}}"){
            displayEvents();
        }else if("{{browseType}}" == "{{possibleViews.projects}}"){
            document.getElementById("searchOptions.project").className = "active";
            {% if projects %}
                document.getElementById("projectsViewDiv").innerHTML = createViewProjectsTable();
            {% else %}
                document.getElementById("projectsViewDiv").innerHTML = "<h3> No projects posted </h3>";
            {% endif %}
        }else if("{{browseType}}" == "{{possibleViews.users}}"){
            displayUsers();
        }else if("{{browseType}}" == "{{possibleViews.posts}}"){
            displayPosts();
        }
    });
</script>-->

{% endblock %}
