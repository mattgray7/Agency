{% extends "base.html" %}

{% block content %}
{% load static %}
<link href="{% static "/AgencyApp/css/profile.css" %}" rel="stylesheet" type="text/css" media="all" />
<script type="text/javascript" src="{% static "/AgencyApp/js/post/post.js" %}"></script>
<script type="text/javascript" src="{% static "/AgencyApp/js/profile.js" %}"></script>
<script>
    var activeInterest = "work";
    var profileTabs = ["bio", "filmography", "media", "endorsements"];
    var profileTabDisplayFunctions = {"bio": displayBio, "filmography": displayFilmography, "media": displayMedia,"endorsements": displayEndorsements};

    function selectProfileTab(tabType){
        for(var i=0; i < profileTabs.length; i++){
            var buttonId = profileTabs[i] + "ProfileButton";
            var borderCoverId = profileTabs[i] + "BorderCover";
            var profileButtonDiv = document.getElementById(buttonId);
            var profileButtonBorderCoverDiv = document.getElementById(borderCoverId)
            if(profileButtonDiv != null && profileButtonBorderCoverDiv != null){
                if(profileTabs[i] === tabType){
                    profileButtonBorderCoverDiv.style.opacity = "1";
                    profileButtonDiv.className = "active";
                }else{
                    profileButtonBorderCoverDiv.style.opacity = "0";
                    profileButtonDiv.className = "";
                }
            }
        }
        if(tabType in profileTabDisplayFunctions){
            profileTabDisplayFunctions[tabType]()
        }

        // Update main view panel height after tab content is changed
        updateProfileContentPanelHeight();
    }

    function updateProfileContentPanelHeight(){
        var projectContentPanel = document.getElementById("profileContentPanel")
        if(projectContentPanel != null){
            // All profile buttons are same height, so just use bio
            var tabButtonsHeight = document.getElementById("bioProfileButton").offsetHeight;
            var projectContentHeight = document.getElementById("profileTabContentPanelContainer").offsetHeight;
            projectContentPanel.style.height = tabButtonsHeight + projectContentHeight + "px";
        }
    }

    function displayBio(){
        var tabContent = document.getElementById("profileTabContentPanel");
        if(tabContent != null){
            var bioData = {"About":[{"label": "Name", "value": "{{profileUserAccount.cleanName}}"},
                                         {"label": "Professions", value: getProfessionList()},
                                         {"label": "Education", "value": "{{profileUserAccount.education}}"},
                                         {"label": "Bio", "value": "{{profileUserAccount.bio}}"}],
                           "Contact": [{"label": "Email", "value": "{{profileUserAccount.email}}"},
                                       {"label": "Phone #", "value": "{{profileUserAccount.phoneNumber}}"},
                                       {"label": "Location", "value": "{{profileUserAccount.location}}"}],
                           "Physical": [{"label": "Date of Birth", "value": "{{profileUserAccount.dateOfBirth}}"},
                                        {"label": "Gender", "value": "{{profileUserAccount.gender}}"},
                                        {"label": "Hair Color", "value": "{{profileUserAccount.hairColor}}"},
                                        {"label": "Eye Color", "value": "{{profileUserAccount.eyeColor}}"},
                                        {"label": "Ethnicity", "value": "{{profileUserAccount.ethnicity}}"},
                                        {"label": "Build", "value": "{{profileUserAccount.build}}"},
                                        {"label": "Height", "value": "{{profileUserAccount.height}}"}]
                          }

            // Add text
            var contentString = "<div style='text-align: left; margin-left: 10px; margin-top: 10px;'><ul style='line-height: 26px; margin-bottom: 0px; width: 98%;'>";
            for(section in bioData){
                if(section === "Physical"){
                    {% if not actorDescriptionEnabled %}
                        continue;
                    {% endif %}
                }
                contentString += "<h2>" + section + "</h2><div style='height: 0px; width: 88%; border-top: 1px solid rgba(0,0,0,0.3); margin-top: 3px;'></div>";
                for(record in bioData[section]){
                    if(bioData[section][record]["value"].length > 0 && bioData[section][record]["value"] != "None"){
                        contentString += "<li><strong>" + bioData[section][record]["label"] + "</strong>: "

                        // Check if value is a list
                        if(Object.prototype.toString.call(bioData[section][record]["value"]) === '[object Array]'){
                            for(var i=0; i < bioData[section][record]["value"].length; i++){
                                if(bioData[section][record]["value"][i]["href"] != '')
                                contentString += " <a href='" + bioData[section][record]["value"][i]["href"] + "'>" + bioData[section][record]["value"][i]["label"] + "</a> |"
                            }
                            // Remove last '|' character
                            contentString = contentString.slice(0, -2)
                        }else{
                            contentString += bioData[section][record]["value"];
                        }
                        contentString += "</li>"
                    }
                }
                contentString += "<div style='height: 20px'></div>"
            }
            contentString += "</ul>";

            // Have to add links separately because need to check if they exist before adding
            {% if profileUserAccount.imdbLink or profileUserAccount.resume %}
                // Depending on what links exist, just need to update left margin of each link
                currentLeftMargin = 0;
                contentString += "<div style='position: relative; margin-top: -5px; height: 152px;'><h2>Links</h2><div style='height: 0px; width: 88%; border-top: 1px solid rgba(0,0,0,0.3);'></div>";
                {% if profileUserAccount.imdbLink %}
                    contentString += "<a href='{{profileUserAccount.imdbLink}}'><div class='profileSquareButton'  style='position: absolute; left: " + currentLeftMargin + "px; bottom: 10px;'><img src='{{icons.imdb}}' style='margin-top: 28px;width: 80px;'></div></a>"
                    currentLeftMargin += 110;
                {% endif %}

                {% if profileUserAccount.resume %}
                    contentString += "<a href='/media/{{profileUserAccount.resume}}'><div class='profileSquareButton' style='position: absolute; left: " + currentLeftMargin + "px; bottom: 10px;'><img src='{{icons.resume}}' style='margin-top: 8px;width: 60px;'><div style='font-size: 0.9em;'>Resume</div></div></a>"
                    currentLeftMargin += 110;
                {% endif %}
                contentString += "</div>"
            {% endif %}
            contentString += "</div>";

            // Add edit button
            {% if viewingOwnProfile %}
                contentString += "<div style='position: absolute; top: 5px; right: 12px;'><div class='editButton' onclick='redirect(" + '"{{ possibleDestinations.background }}");' + "'>Edit</div></div>";
            {% endif %}
            
            // Add edit button
            tabContent.innerHTML = contentString;
        }
    }

    function displayFilmography(){
        var tabContent = document.getElementById("profileTabContentPanel")
        if(tabContent != null){
            {% if filmography %}
                var tabString = ""

                // Add left panel listing professions
                /*tabString += "<div style='position: absolute; left: 5px; top: 0px; bottom: 0px; background: rgba(0,0,0,0.05); border: 1px solid rgba(0,0,0,0.1); width: 215px; margin-left: 5px; text-align: left;'>"
                {% if profileProfessions %}
                    tabString += "<h2 style='margin-left: 7px'>Professions</h2><div style='height: 0px; margin-left: 3px;width: 95%; border-top: 1px solid #000;'></div><ul>"
                    {% for profession in profileProfessions %}
                        tabString += "<li style='position: relative; height: 35px; margin: 1px 3px; border-bottom: 1px solid rgba(0,0,0,0.3);'><div style='position: absolute; left: 5px; top: 18px; text-transform: uppercase; font-size: 0.8em;'>{{profession}}</div><input  style='position: absolute; right: 5px; top: 18px;' type='checkbox' /></li>"
                    {% endfor %}
                    tabString += "</ul>"
                {% else %}
                    tabString += "No filmography registered."
                {% endif %}

                tabString += "</div>";*/

                var filmography = {{filmography|safe}};
                tabString += "<div style='margin-left: 10px; margin-right: 10px; margin-top: 10px;'><h2 style='text-align: left; margin-bottom: 1px;'>Filmography</h2><div style='height: 0px;width: 100%; border-top: 1px solid #000; margin-bottom: 5px;'></div>" + createProjectFeed(filmography, false) + "</div>"

                
                // Start with edit button
                {% if viewingOwnProfile %}
                    tabString += "<div style='position: absolute; top: 5px; right: 12px;'><div class='editButton'  onclick='redirect(" + '"{{ possibleDestinations.filmography }}");' + "'>Edit</div></div>";
                {% endif %}

                tabContent.innerHTML = tabString;
            {% endif %}
        }
    }

    function displayMedia(){
        var tabContent = document.getElementById("profileTabContentPanel")
        if(tabContent != null){
            var tabString = "<div style='position: relative; min-height: 100px; width: 100%;'>";

            // Start with edit button
            {% if viewingOwnProfile %}
                tabString += "<div style='position: absolute; top: 5px; right: 12px;'><div class='editButton'  onclick='redirect(" + '"{{ possibleDestinations.media }}");' + "'>Edit</div></div>";
            {% endif %}

            // Content container
            tabString += "<div style='margin-left: 10px; margin-right: 10px; margin-top: 10px;'>";

            // Photos container
            tabString += "<div style='height: 299px;'><h2 style='text-align: left; margin-bottom: 1px;'>Photos</h2><div style='height: 0px; width: 100%; border-top: 1px solid #000; margin-bottom: 5px;'></div>";

            // Add picture list
            {% if profileUserAccount.profileMediaPictures %}
                tabString += "<div id='mediaPicturesListPanel' style='position: absolute; left: 10px; right: 10px; top: 40px; height: 255px; background: #FFF; overflow: hidden; '><div id='mediaPicturesList' style='text-align: left; max-height: 255px; overflow-x: scroll; overflow-y: hidden; white-space: nowrap; background: rgba(0,0,0,0.1);background: rgba(0,0,0,0.05); border: 1px solid rgba(158, 192, 247, 0.2);'>";
                {% for picture in profileUserAccount.profileMediaPictures %}
                    tabString += getProfileMediaPictureString("{{picture.id}}", "{{picture.url}}", "{{picture.description}}");
                {% endfor %}
                tabString += "</div></div>";
            {% endif %}
            
            tabString += "</div>"
            tabString += "</div>"


            tabContent.innerHTML = tabString;
        }
    }

    function displayFullPagePicture(pictureID){
        var picture;
        if(pictureID === "profilePicture"){
            {% if profileUserAccount.profilePicture and profileUserAccount.profilePicture.path %}
                picture = {"url": "{{profileUserAccount.profilePicture.path}}",
                           "id": "profilePicture"
                          };
            {% endif %}
        }else{
            {% if profileUserAccount.profileMediaPictures %}
                {% for pictureDict in profileUserAccount.profileMediaPictures %}
                    if("{{pictureDict.id}}" === pictureID){
                        picture = {"url": "{{pictureDict.url}}",
                                   "id": "{{pictureDict.id}}",
                                   "description": "{{pictureDict.description}}",
                                   "createdAt": "{{pictureDict.createdAt}}",
                                   "poster": "{{pictureDict.poster}}"}
                    }
                {% endfor %}
            {% endif %}
        }
        if(picture != null){
            displayPicture(picture);
        }
    }

    function addNewEndorsement(){
        var textArea = document.getElementById('newEndorsementTextArea');
        if(textArea != null){
            {% if request.user.is_authenticated %}
                if(textArea.value != null && textArea.value.length > 0){
                    $.ajax({
                        url : "/ajax/createProfileEndorsement/",
                            data : {"username": "{{profileUserAccount.username}}", "description": textArea.value},
                            type : 'POST',
                            dataType: "json",
                            success : function(data) {
                                if(data["success"]){
                                    var newEndorsement = {"postID": data["postID"],
                                                          "username": "{{profileUserAccount.username}}",
                                                          "description": textArea.value,
                                                          "createdAt": currentDateString,
                                                          "poster": {"username": "{{userAccount.username}}",
                                                                     "cleanName": "{{userAccount.cleanName}}",
                                                                     "profilePictureURL": "{{userAccount.profilePicture.url}}",
                                                                     "profession": "{{userAccount.mainProfession}}"}
                                                          }
                                    endorsementList.unshift(newEndorsement)

                                    if(displayEndorsementFeed()){
                                        textArea.value = ""
                                    }
                                }
                            }
                    });
                }else{
                    console.log("You must enter text")
                }
            {% else %}
                console.log("You must be logged in to submit")
            {% endif %}
        }
    }

    function deleteProfileEndorsement(postID){
        if(postID != null && postID.length > 0){
            var postIndex;
            for(var i=0; i < endorsementList.length; i++){
                if(endorsementList[i]["postID"] === postID){
                    postIndex = i;
                    break;
                }
            }

            if(postIndex != null){
                {% if request.user.is_authenticated %}
                    if("{{request.user.username}}" === endorsementList[postIndex]["username"] || "{{request.user.username}}" === endorsementList[postIndex]["poster"]["username"]){
                        $.ajax({
                            url : "/ajax/deleteProfileEndorsement/",
                            data : {"postID": postID, "profileUsername": "{{profileUserAccount.username}}"},
                            type : 'POST',
                            dataType: "json",
                            success : function(data) {
                                if(data["success"]){
                                    endorsementList.splice(postIndex, 1);
                                    displayEndorsementFeed();
                                }
                            }
                        });
                    }
                {% endif %}
            }
        }
    }

    function updateProfileEndorsement(postID){
        if(postID != null && postID.length > 0){
            var description = document.getElementById("endorsementDescriptionText_" + postID);
            var container = document.getElementById("endorsementDescription_" + postID);
            var row = document.getElementById("endorsementElement_" + postID);
            if(container != null && row != null && description != null && description.value.length > 0){
                $.ajax({
                    url : "/ajax/updateProfileEndorsement/",
                    data : {"postID": postID, "newDescription": description.value},
                    type : 'POST',
                    dataType: "json",
                    success : function(data) {
                        if(data["success"]){
                            // Update the description values
                            container.innerHTML = getEndorsementDescriptionString(false, description.value, postID)

                            // Can cancel the edit, but since descriptions are updated, new value is displayed
                            toggleEditProfileEndorsement("shrink", postID)
                        }
                    }
                });
            }
        }
    }

    function toggleEditProfileEndorsement(toggleType, postID){
        if(postID != null && postID.length > 0){
            var description = document.getElementById("endorsementDescription_" + postID);
            var row = document.getElementById("endorsementElement_" + postID);
            var editButton = document.getElementById("endorsementEditButton_" + postID)
            if(description != null && row != null && editButton != null){
                if(toggleType === "expand"){
                    editButton.innerHTML = "Cancel";
                    editButton.onclick = function(){
                        toggleEditProfileEndorsement("shrink", postID)
                    }

                    var editString = "<textarea id='endorsementDescriptionText_" + postID + "' style='font-size: 0.9em; ; resize: none; min-height: 70px; width: 98.7%; border-radius: 3px; border: 1px solid rgba(0,0,0,0.3);'>" + endorsementDescriptionMap[postID]["short"] + "</textarea>";

                    editString += "<div style='float: right; height: 40px; margin-top: 1px; text-align: center;'><div style='width: 50px; margin-right: 5px; display: inline-block; padding: 3px 5px;' class='editButton' onclick='deleteProfileEndorsement(" + '"' + postID + '"' + ");'>Delete</div><div class='editButton' onclick='updateProfileEndorsement(" + '"' + postID + '"' + ");' style='display: inline-block; width: 50px; padding: 3px 5px;'>Update</div></div>";

                    description.innerHTML = editString;
                    row.style.height = endorsementFeedElementHeight + 30 + "px";
                    updateProfileContentPanelHeight();
                }else{
                    editButton.innerHTML = "Edit";
                    editButton.onclick = function(){
                        toggleEditProfileEndorsement("expand", postID)
                    }

                    description.innerHTML = endorsementDescriptionMap[postID]["short"]
                    row.style.height = endorsementFeedElementHeight + "px";
                    updateProfileContentPanelHeight();
                }
            }
        }
    }

    function toggleExpandEndorsementDescription(toggleType, postID){
        if(postID != null && postID.length > 0){
            if(postID in endorsementDescriptionMap){
                var description = document.getElementById("endorsementDescription_" + postID);
                var row = document.getElementById("endorsementElement_" + postID);
                if(description != null && row != null){
                    if(toggleType === "expand"){
                        var currentDescriptionHeight = description.offsetHeight;
                        description.innerHTML = endorsementDescriptionMap[postID]["full"] + "<a onclick='toggleExpandEndorsementDescription(" + '"shrink", "' + postID + '");' + "'>... See less</a>"
                        var newDescriptionHeight = description.offsetHeight;

                        row.style.height = endorsementFeedElementHeight + (newDescriptionHeight - currentDescriptionHeight) + "px";
                        updateProfileContentPanelHeight();
                    }else{
                        description.innerHTML = endorsementDescriptionMap[postID]["short"]
                        row.style.height = endorsementFeedElementHeight + "px";
                        updateProfileContentPanelHeight();
                    }
                }
            }
        }
    }

    function displayEndorsementFeed(){
        var feedContainer = document.getElementById("profileEndorsementFeedContainer");
        if(feedContainer != null){
            feedContainer.innerHTML = createEndorsementFeed();
            updateProfileContentPanelHeight();
            return true;
        }
    }

    var maxDescriptionLength = 250;
    function getEndorsementDescriptionString(expanded, fullDescription, postID){
        // Add description
        var description = fullDescription;
        if(description.length > maxDescriptionLength){
            description = description.substring(0, maxDescriptionLength) + "... <a onclick='toggleExpandEndorsementDescription(" + '"expand", "' + postID + '");' + "'>See more</a>"
        }
        endorsementDescriptionMap[postID] = {"full": fullDescription, "short": description}
        return description
    }

    var endorsementDescriptionMap = {};
    var endorsementFeedElementHeight = 150;
    function createEndorsementFeed(){
        var feedString = "<ul class='projectFeed'>"
        if(endorsementList.length > 0){
            for(var i=0; i < endorsementList.length; i++){
                feedString += "<li id='endorsementElement_" + endorsementList[i]["postID"] + "' class='projectFeedElement' style='height: " + endorsementFeedElementHeight + "px; position: relative;'>"

                // Add poster picture
                feedString += "<div style='position: absolute; left: 10px; top: 10px; height: 130px; overflow: hidden;'><img src='" + endorsementList[i]["poster"]["profilePictureURL"] + "' style='height: 100%;' /></div>"

                // Add text container
                feedString += "<div style='position: absolute; left: 135px; top: 10px; right: 10px; bottom: 10px; text-align: left;'>"
                // Add title
                feedString += "<h3>Posted by <a onclick='redirectToUser(" + '"' + endorsementList[i]["poster"]["username"] + '");' + "'>" + endorsementList[i]["poster"]["cleanName"] + "</a></h3>";
                // Add date
                feedString += "<h4 style='margin: 0; font-size: 0.9em; color: rgba(0,0,0,0.6);'>" + endorsementList[i]["createdAt"] + "</h4><div style='height: 6px; border-bottom: 1px solid rgba(0,0,0,0.7); margin-bottom: 3px;'></div>"

                // Add edit button if user wrote the review
                // Add delete button if user is viewing his own progile
                feedString += "<div style='position: absolute; right: 0px; top: -5px; text-align: center;'>";
                var addDelete = false;
                if(endorsementList[i]["poster"]["username"] === "{{request.user.username}}"){
                    feedString += "<div class='editButton' id='endorsementEditButton_" + endorsementList[i]["postID"] + "' onclick='toggleEditProfileEndorsement(" + '"expand", "' + endorsementList[i]["postID"] + '"' + ");'>Edit</div>";
                }else{
                    {% if viewingOwnProfile %}
                        feedString += "<div style='margin-top: 4px;' class='editButton' onclick='deleteProfileEndorsement(" + '"' + endorsementList[i]["postID"] + '"' + ");'>Delete</div>";
                    {% endif %}
                }
                feedString += "</div>"

                feedString += "<div id='endorsementDescription_" + endorsementList[i]["postID"] + "' style='font-size: 0.9em;'>" + getEndorsementDescriptionString(true, endorsementList[i]["description"], endorsementList[i]["postID"]) + "</div>"

                // Close text container
                feedString += "</div>"

                feedString += "</li>"
            }
        }
        feedString += "</ul>"
        return feedString
    }

    // profile button
    var endorsementList = [];
    function displayEndorsements(){
        var tabContent = document.getElementById("profileTabContentPanel")
        if(tabContent != null){
            //var tabString = "<div style='position: relative; min-height: 100px; width: 100%;'>";
            var tabString = "<div style='text-align: left; margin-bottom: -16px;'>";

            if(endorsementList.length === 0){
                {% if profileEndorsements %}
                    endorsementList = {{profileEndorsements|safe}};
                {% endif %}
            }

            // Add text panel
            tabString += "<div style='position: relative; background:rgba(0,0,0,0.03); height: 155px; margin: 5px 10px; padding: 5px; border-radius: 3px'><h1 >Add an endorsement!</h1>"
            tabString += "<textarea id='newEndorsementTextArea' class='formInputElement' style='font-size: 0.9em; min-height: 75px; resize: none; width: 100%; border-radius: 3px; border: 1px solid rgba(0,0,0,0.3);' placeholder='Matt was great to work with on The 4400, a true professional!'></textarea>";
            tabString += "<div class='editButton' onclick='addNewEndorsement();' style='position: absolute; right: 5px; bottom: 5px; padding: 5px 10px;text-align: center;'>Submit</div>"
            tabString += "</div>"

            tabString += "<div id='profileEndorsementFeedContainer'>" + createEndorsementFeed() + "</div>"
            tabString += "</div>";
            tabContent.innerHTML = tabString;
        }
    }

    function getProfessionList(){
        // TODO use 'mainProfessionList' or whatever its called instead of interested work professions
        var returnString = '';
        {% if profileProfessions %}
            returnString += '<div class="profileProfessionList"><ul>';
            var elementEnding = "|&#160;</li>";
            {% for profession in profileProfessions %}
                returnString += '<li>{{profession}} ' + elementEnding;
            {% endfor %}
            if(returnString.endsWith(elementEnding)){
                returnString = returnString.substring(0, returnString.length-elementEnding.length)
                returnString += "</li>"
            }
            returnString += '</ul></div>';
        {% endif %}
        return returnString;
    }

    function getWorkHireTextPanel(){
        return "working and hiring"
    }

    function getWorkTextPanel(){
        var panelString = "<div style='margin-left: 5px;'>";
        var callbacks = []
        panelString += "<h2 style='margin-top: 5px;'>Looking for work</h2>"
        {% if profileInterests.work %}
            panelString += ""

            // Add sub title
            panelString += "<h3 style='font-size: 0.9em; color: rgba(0,0,0,0.5);'>" + "{{profileUserAccount.cleanName}}".split(" ")[0] + " is interested in working as:</h3>"

            var projects = {};
            {% if filmography %}
                projects = {{filmography|safe}};
            {% endif %}

            // Create a dict of professions, and how many projects in their filmography match the profession
            var professionList = []
            {% for interest in profileInterests.work %}
                var creditCount = 0;
                for(var projectID in projects){
                    if(projects[projectID]["labels"].length > 0){
                        for(var i=0; i < projects[projectID]["labels"].length; i++){
                            if("{{interest.professionName}}" === projects[projectID]["labels"][i]["label"]){
                                creditCount++;
                            }
                        }
                    }
                }
                professionList.push({"profession": "{{interest.professionName}}", "creditCount": creditCount})
            {% endfor %}


            panelString += "<ul>"
            for(var i=0; i < Math.min(5, professionList.length); i++){
                panelString += "<li>" + professionList[i]["profession"]
                if(professionList[i]["creditCount"] > 0){
                    panelString += " (" + professionList[i]["creditCount"] + " credit"
                    if(creditCount > 1){
                        panelString += "s"
                    }
                    panelString += ")"
                }
                panelString += "</li>";
            }

            if(professionList.length > 5){
                panelString += "<li><div id='extraProfessionsRowElement' style='cursor: pointer; width: 28%;'>" + (professionList.length-5) + " more jobs...</div></li><ul>";

                // Add hover panel
                panelString += "<div id='extraProfessionsHoverPanel' style='position: absolute; left: 100px; top: 84%; width: 200px; background: #FFF; border: 1px solid rgba(0,0,0,1); display: none; z-index: 5; padding: 5px; border-radius: 3px;'><ul>"
                for(var i=5; i < professionList.length; i++){
                    panelString += "<li>" + professionList[i]["profession"]
                    if(professionList[i]["creditCount"] > 0){
                        panelString += " (" + professionList[i]["creditCount"] + " credit"
                        if(creditCount > 1){
                            panelString += "s"
                        }
                        panelString += ")"
                    }
                    panelString += "</li>";
                }
                panelString += "</ul></div>"

                // Add hover callback for extra jobs
                callbacks.push(function(){
                    // Add hover on extra professions string
                    $("#extraProfessionsRowElement").hover(function(){
                            // Just display the hover panel
                            $("#extraProfessionsHoverPanel").css("display", "block");
                        },
                        function(){
                            // If the mouse is hovering over the hover panel, want to keep it displayed
                            var isHovered = $('#extraProfessionsHoverPanel').is(":hover");
                            if(!isHovered){
                                // Not hovering over hover panel, so can hide it
                                $("#extraProfessionsHoverPanel").css("display", "none");
                            }else{
                                // Hovering over hover panel, so hide callback on unhovering hover panel
                                $('#extraProfessionsHoverPanel').hover(function(){}, function(){
                                    $("#extraProfessionsHoverPanel").css("display", "none");
                                });
                            }
                        }
                    );
                })
            }else{
                panelString += "</ul>"
            }
        {% endif %}
        panelString += "</div>"
        return {'html': panelString, 'callbacks': callbacks};
    }

    function getHireTextPanel(){
        var callbacks = [];

        return {"html": "hiring", "callbacks": callbacks}
    }

    function getDefaultTextPanel(){
        return "default"
    }

    function getProfileHeaderTextPanel(){
        var panelString = "<div style='width: 100%; height: 100%; position: relative; text-align: left;'>"
        var callbacks = []
        // Add edit button
        {% if viewingOwnProfile %}
            panelString += "<div style='position: absolute; top: 5px; right: 5px;'><div class='editButton' onclick='redirect(" + '"{{ possibleDestinations.interests }}");' + "'>Edit</div></div>";
        {% endif %}

        var newInfo
        {% if profileUserAccount.workInterest and profileUserAccount.hireInterest %}
            newInfo = getWorkHireTextPanel();
        {% elif profileUserAccount.workInterest %}
            newInfo = getWorkTextPanel();
        {% elif profileUserAccount.hireInterest %}
            newInfo = getHireTextPanel();
        {% else %}
            newInfo = getDefaultTextPanel();
        {% endif %}
        panelString += newInfo['html']
        panelString += "</div>"

        callbacks = callbacks.concat(newInfo["callbacks"])
        return {"html": panelString, "callbacks": callbacks};
    }
</script>

    <script>
        function getHiringList(){
            var returnString = '';
            {% if profileInterests.hire %}
                returnString += '<div class="profileProfessionList"><ul>'
                {% for interest in profileInterests.hire %}
                    {% if interest.subInterest == "hireProject" %}
                        returnString += "<li>Projects</li>";
                    {% elif interest.subInterest == "hirePermanent" %}
                        returnString += "<li>Permanent Positions</li>";
                    {% elif interest.subInterest == "casting" %}
                        returnString += "<li>Casting</li>";
                    {% elif interest.subInterest == "collaborating" %}
                        returnString += "<li>Collaborating</li>"
                    {% endif %}
                {% endfor %}
                returnString += "</ul></div>";
            {% endif %}
            return returnString;
        }

        function toggleInterest(buttonElement, interestType){
            if(interestType != activeInterest){
                // Set this button to active
                var newActiveButtonId = interestType + "ToggleInterestButton";
                var newActiveButton = document.getElementById(newActiveButtonId);
                if(newActiveButton != null){
                    newActiveButton.className = "blackButton";
                }
                var oldActiveButtonId = activeInterest + "ToggleInterestButton";
                var oldActiveButton = document.getElementById(oldActiveButtonId);
                if(oldActiveButton != null){
                    oldActiveButton.className = "whiteButton";
                }
                activeInterest = interestType;
                document.getElementById("interestTitle").innerHTML = getInterestTitle(interestType)
                if(interestType === "work"){
                    document.getElementById("interestContent").innerHTML = getProfessionList();
                }else if(interestType === "hire"){
                    document.getElementById("interestContent").innerHTML = getHiringList();
                }
            }
        }

        function getInterestTitle(interestType){
            var headerTag = "<h2>";
            {% if profileUserAccount.workInterest and profileUserAccount.hireInterest %}
                headerTag = "<h2 style='padding: 10px 0px 1px 0px;'>";
            {% endif %}

            var interestTitle = "";
            if(interestType === "work"){
                interestTitle = headerTag + "Seeking Work</h2>"
            }else if(interestType === "hire"){
                interestTitle = headerTag + "Hiring</h2>"
            }else{
                interestTitle = "<h3>No interests selected</h3>";
            }
            return interestTitle
        }


        function createProjectListElement(projectID, projectPictureURL, title, status, involvementString){
            var projectString = "<li id='profileProjectListElement_" + projectID + "' class='profileProjectListElement' onclick='redirectToPost(" + '"' + projectID + '");' + "'>"
            projectString += "<div class='profileProjectListElementImageContainer'>" + getPictureTag(projectPictureURL, "profileProjectListElementImage", "") + "</div>";
            projectString += "<div class='profileProjectListElementText'><h3>" + title + "</h3><h5>" + status + "<br>" + involvementString + "<br>"

            /*if(numOpenRoles > 0){
                projectString += parseInt(numOpenRoles) + " ";
                if(numOpenRoles === 1){
                    projectString += "role";
                }else{
                    projectString += "roles";
                }
                projectString += " available<br>"
            }else{
                projectString += "<br>";
            }
            if(numOpenJobs > 0){
                projectString += "Hiring for " + parseInt(numOpenJobs) + " ";
                if(numOpenJobs === 1){
                    projectString += "position";
                }else{
                    projectString += "positions";
                }
            }else{
                projectString += "<br>";
            }*/
            projectString += "</h5></div></li>";
            return projectString
        }

        function getInvolvementString(projectID, rolesString, jobsString, creator){
            var jobs = JSON.parse(jobsString.replace(/&quot;/g, '"'));
            var roles = JSON.parse(rolesString.replace(/&quot;/g, '"'));
            var returnString = "";
            var padCount = 0;
            if(creator === "True"){
                returnString += "Creator<br>";
                padCount -= 1;
            }else{
                padCount += 1;
            }
            if(roles.length > 0){
                if(roles.length === 1){
                    returnString += "Actor (<a onclick='redirectToPost(" + '"' + roles[0]["postID"] + '");' + "'>" + roles[0]["characterName"] + "</a>)<br>"
                }else{
                    returnString += "Actor (<a onclick='redirectToPost(" + '"' + projectID + '");' + "'>" + roles.length + " roles</a>)<br>"
                }
            }else{
                padCount += 1;
            }
            if(jobs.length > 0){
                returnString += "Worked as ";
                for(var i=0; i < jobs.length; i++){
                    returnString += "<a onclick='redirectToPost(" + '"' + jobs[i]["postID"] + '");' + "'>" +  jobs[i]["profession"] + "</a>";
                    if(i != jobs.length-1){
                        returnString += ", ";
                    }
                }
            }else{
                padCount += 1
            }
            if(padCount > 0){
                for(var i=0; i < padCount-1; i++){
                    returnString += "<br>";
                }
            }
            return returnString
        }

        function createProjectsList(status){
            var displayString = "";
            {% if profilePosts.projects %}
                displayString += "<div id='" + status + "ProjectPanel' class='projectListPanel'><ul class='profileProjectList'><li><h2>"
                if(status === "current"){
                    displayString += "Current Projects";
                }else{
                    displayString += "Past Projects";
                }
                displayString += "</h2></li>";
                {% for projectPost in profilePosts.projects %}
                    
                    if("{{projectPost.status}}" === status){
                        var picURL = null
                        {% if projectPost.project.postPicture %}
                            picURL = "{{ projectPost.project.postPicture.url }}"
                        {% endif %}

                        var involvementString = getInvolvementString("{{projectPost.project.postID}}", "{{projectPost.roles}}", "{{projectPost.jobs}}", "{{projectPost.creator}}")
                        displayString += createProjectListElement("{{projectPost.project.postID}}", picURL, "{{projectPost.project.title}}", "{{projectPost.project.status}}", involvementString)
                    }
                {% endfor %}
                displayString += "</ul></div>";
            {% endif %}
            return displayString;
        }

        function displayBackground(){
            var profileDisplayPanelDiv = document.getElementById("profileDisplayPanel")
            if(profileDisplayPanelDiv != null){
                var backgroundString = "";
                {% if hasCurrentProjects %}
                    backgroundString += createProjectsList("current")
                {% endif %}
                {% if hasPastProjects %}
                    backgroundString += createProjectsList("past")
                {% endif %}
                if(backgroundString === ""){
                    backgroundString = "{{profileUserAccount.firstName}} has not registered any projects."
                }
                profileDisplayPanelDiv.innerHTML = backgroundString;
            }
        }
    </script>

<div id='backgroundPanel' class='backgroundPanel' style='min-width: 634px; min-height: 100%;'>
    <div id="mainViewPanel" class="mainViewPanel" style="position: relative; min-width: 620px; max-width: 675px; background: rgba(0,0,0,0.05); border: none;">
        {% if profileUserAccount %}
            <div style='height: 350px; width: 100%; position: relative;'>
                <div id='profileHeaderPanel' class='profileHeaderPanel' style='position: absolute; right: 2px; left: 0px; margin: 0 auto; top: 0; bottom: 0;'>
                    <div style='position: relative; width: 100%; height: 100%;'>
                        <div style='position: absolute; left: 15px; top: 15px;'>
                            {% if profileUserAccount.profilePicture %}
                                <img class="profilePicture" src="{{ profileUserAccount.profilePicture.url }}" />
                            {% else %}
                                <img class="profilePicture" src="{{ images.noProfilePicture }}"/>
                            {% endif %}
                        </div>
                        <div style='position: absolute; left: 15px; top: 275px; text-align: left;'>
                            <h1><a onclick='redirectToUser("{{profileUserAccount.username}}");' >{{profileUserAccount.cleanName}}</a></h1>
                            <script>document.write(getProfessionList())</script>
                        </div>
                        <div style='position: absolute; left: 240px; right: 0px; top: 0; bottom: 0; margin: 15px; background: rgba(0,0,0,0.04);'>
                            <div style='position: relative; height: 100%; border: 1px solid rgba(0,0,0,1);'>
                                <div style='position: absolute; top: 0px; height: 190px; left: 0; right: 0; border: 0px solid #aea;'>
                                    <script>
                                        var headerTextInfo = getProfileHeaderTextPanel()
                                        document.write(headerTextInfo['html'])
                                        if(headerTextInfo['callbacks'].length > 0){
                                            for(var i=0; i < headerTextInfo['callbacks'].length; i++){
                                                if(headerTextInfo["callbacks"][i] != null){
                                                    headerTextInfo["callbacks"][i]();
                                                }
                                            }
                                        }
                                    </script>
                                </div>

                                {% if profileUserAccount.hasFeaturedMediaPictures %}
                                    <div style='position: absolute; bottom: 0px; height: 130px; left: 0; right: 0; ; white-space: nowrap; overflow: hidden; text-align: left;'>
                                        {% for picture in profileUserAccount.profileMediaPictures %}
                                            {% if picture.featured %}
                                                <div style='display: inline-block; margin-right: 5px; border: 1px solid rgba(0,0,0,0.1);'>
                                                    <img src='{{picture.url}}' style='height: 130px; width: 117px;' />
                                                </div>
                                            {% endif %}
                                        {% endfor %}

                                    </div>
                                {% endif %}


                            </div>

                        </div>
                    </div>
                </div>
            </div>
            <div id='profileContentPanel' style='position: relative; width: 100%; min-height: 100px; margin-top: 10px;'>
                <ul class='profileTabButtonList' id='profileTabButtonList' style=''>
                    <script>
                        for(var i=0; i < profileTabs.length; i++){
                            // Specify margin for each button in order (TODO create a functino to create a 4 tab list)
                            var styleString = "position: absolute;"
                            if(i === 0){
                                styleString += "left: -4px;"
                            }else if(i === 1){
                                styleString += "left: 24.7%;"
                            }else if(i === 2){
                                styleString += "left: 49.7%;"
                            }else if(i === 3){
                                styleString += "right: 2px;"
                            }
                            var tabButton = '<li style="width: 24%; ' + styleString + '" id="' + profileTabs[i] + 'ProfileButton" onclick="selectProfileTab(' + "'" + profileTabs[i] + "');" + '"><div style="margin-top: 5px;">' + profileTabs[i] + '</div><div id="' + profileTabs[i] + 'BorderCover" class="profileTabButtonBorderCover"></div></li>';
                            document.write(tabButton);
                        }
                    </script>
                </ul>
                <div id='profileTabContentPanelContainer' style='position: absolute; border: 1px solid #000; top: 50px; left: 0px; right: 2px; margin-top: -7px;  background: #FFF; z-index: 0; min-height: 50px;'>
                    <div id='profileTabContentPanel' style='position: relative;'>

                    </div>
                </div>
            </div>
        {% else %}
            No user Found
        {% endif %}
    </div>
</div>

<script>
var defaultTab = "bio";
if("{{source}}" === "EDIT_FILMOGRAPHY"){
    defaultTab = "filmography";
}else if("{{source}}" === "EDIT_PROFILE_PICTURE"){
    defaultTab = "media"
}

//for testing
defaultTab = "media"
selectProfileTab(defaultTab)
</script>



<!--
    {% if profileUserAccount %}
        <div id="profilePageDiv">
            <table id="profilePageTable" class="profileTable">
                <tr>
                    <td class="profileTableMainColumn">
                        <table style="height:100%; width:100%; border-spacing:0.2em; margin: 0px -5px 0px 5px;">
                            <tr>
                                <td class="profilePanel profilePicturePanel">
                                    <div id="profilePictureBoundingBox" class="hoverContainer" style="width:250px; height:278px; background: #000; border: 2px solid #000; border-radius:6px;">
                                        {% if profileUserAccount.profilePicture %}
                                            <div id="profilePictureDiv">
                                                <img src="{{ profileUserAccount.profilePicture.url }}" style="width:250px;"/>
                                            </div>
                                        {% else %}
                                            <div id="profilePictureDiv">
                                                <img src="{{ images.noProfilePicture }}" style="width:250px;"/>
                                            </div>
                                        {% endif %}
                                        {% if viewingOwnProfile %}
                                            <div class="grayAlphaOverlay"></div>
                                            <div class="whiteHoverButton"><a onclick="redirect('{{ possibleDestinations.picture }}');"> Edit </a></div>
                                        {% endif %}
                                    </div>
                                    <div id="profileBackgroundDiv" class="hoverContainer">
                                        <div id="profileBackgroundTextDiv" style="width: 245px; word-wrap: break-word; padding: 0em 0.3em 0em 0.3em;">
                                            <h1>{{ displayName }} </h1>
                                            {% if profileUserAccount.mainProfession %}
                                                <h3> {{profileUserAccount.mainProfession}} </h3>
                                            {% endif %}
                                            {% if profileUserAccount.bio %}
                                                <p class="profileBioText"> {{ profileUserAccount.bio }} </p>
                                            {% endif %}

                                            {% if viewingOwnProfile %}
                                                <div class="hoverButton">
                                                    <a onclick="redirect('{{ possibleDestinations.background }}');">Edit</a>
                                                </div>
                                            {% endif %}
                                        </div>

                                        {% if profileLinks %}
                                            <div id="profileLinksDiv" style="height: 30px; padding: 0.5em 0em 0em 0em;">
                                                <table style="border-width:6px;">
                                                    <tr>
                                                        {% for link in profileLinks %}
                                                            {% if link.url and link.label %}
                                                                <td>
                                                                    <div class="whiteButton blackHover" style="padding: 1px 4px 1px 4px; display:inline; z-index:2; position: relative;" onclick="window.location.href='{{link.url}}';">
                                                                        {{ link.label }}
                                                                    </div>
                                                                </td>
                                                            {% endif %}
                                                        {% endfor %}
                                                    </tr>
                                                </table>
                                            </div>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <td class="profilePanel interestsPanel" style="width:259px">
                                    <div id="interestsPanel" class="hoverContainer">
                                        <table>
                                            {% if profileUserAccount.workInterest and profileUserAccount.hireInterest %}
                                                <tr>
                                                    <td style="display: inline;">
                                                        <div class="blackButton" id="workToggleInterestButton" onclick="toggleInterest(this, 'work');" style="padding: 1px 37px 1px 37px; display:inline; z-index:1; position: relative; border-radius: 1px;">
                                                            Work
                                                        </div>
                                                        <div class="whiteButton" id="hireToggleInterestButton" onclick="toggleInterest(this, 'hire');" style="padding: 1px 37px 1px 37px; display:inline; z-index:1; position: relative; border-radius: 1px;">
                                                            Hiring
                                                        </div>
                                                    </td>
                                                </tr>
                                            {% endif %}

                                            {% if viewingOwnProfile %}
                                                {% if profileUserAccount.workInterest and profileUserAccount.hireInterest %}
                                                    <div class="hoverButton" style="z-index:2; top: 45px;">
                                                {% elif profileUserAccount.workInterest or profileUserAccount.hireInterest%}
                                                    <div class="hoverButton" style="z-index:2; top: 9px;">
                                                {% else %}
                                                    <div class="hoverButton" style="z-index:2; top: 5px;">
                                                {% endif %}
                                                    <a onclick="redirect('{{ possibleDestinations.interests }}');">Edit</a>
                                                </div>
                                            {% endif %}
                                            <tr>
                                                <td>
                                                    <div id="interestTitle"></div>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td>
                                                    <div id="interestContent"></div>
                                                </td>
                                            </tr>
                                        </table>
                                    </div>
                                </td>
                            </tr>
                        </table>
                    </td>
                    <td colspan="2" class="profileTableMainColumn" style="width:50%; max-width:50%: position:relative;">
                        <table style="height:100%; position:absolute; top: 100px;">
                            <tr style="height: 100%; margin: 0px;">
                                <td>
                                    <div class="profilePanel postsPanel" style="min-width: 500px; width:100%; height: 100%; margin-top: -11px; margin-left: -12px; background:none; border:none;">
                                        <table>
                                            <tr>
                                                <td style="text-align:center; min-width: 515px;">
                                                    <div class="profileTabButtonInactive" id="backgroundProfileButton" onclick="selectProfileTab('background')" style="margin-left: -3px;">
                                                        Background
                                                        <div id="backgroundBorderCover" class="profileTabBorderCover"></div>
                                                    </div>
                                                    <div class="profileTabButtonInactive" id="postsProfileButton" onclick="selectProfileTab('posts')" style="margin-left:2px;">
                                                        Posts
                                                        <div id="postsBorderCover" class="profileTabBorderCover"></div>
                                                    </div>
                                                    <div class="profileTabButtonInactive" id="eventsProfileButton" onclick="selectProfileTab('events')" style="margin-right: 1px">
                                                        Events
                                                        <div id="eventsBorderCover" class="profileTabBorderCover"></div>
                                                    </div>
                                                    <div class="profileTabButtonInactive" id="reviewsProfileButton" onclick="selectProfileTab('reviews')" style="margin-right: -3px;">
                                                        Reviews
                                                        <div id="reviewsBorderCover" class="profileTabBorderCover" style="width: 132%;"></div>
                                                    </div>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td>
                                                    <div id="profileDisplayPanel" class="profileDisplayPanel"></div>
                                                </td>
                                            </tr>
                                        </table>
                                    </div>
                                </td>
                            </tr>
                            
                        </table>
                    </td>
                    <td class="profileTableMainColumn" style="width:20%">
                        
                    </td>
                </tr>
            </table>
            <script>
                // Have to do script outside of table, otherwise it affects formatting
                var interestDiv = document.getElementById("interestContent");
                var interestTitleDiv = document.getElementById("interestTitle")
                if(interestDiv != null && interestTitleDiv != null){
                    var headerTag = "<h2>";
                    {% if profileUserAccount.workInterest and profileUserAccount.hireInterest %}
                        headerTag = "<h2 style='padding: 10px 0px 1px 0px;'>";
                    {% endif %}

                    {% if profileUserAccount.workInterest %}
                        interestDiv.innerHTML = getProfessionList();
                        interestTitleDiv.innerHTML = getInterestTitle("work")
                    {% elif profileUserAccount.hireInterest %}
                        interestDiv.innerHTML = getHiringList();
                        interestTitleDiv.innerHTML = getInterestTitle("hire")
                    {% else %}
                        interestDiv.innerHTML = ""
                        interestTitleDiv.innerHTML = getInterestTitle("other")
                    {% endif %}
                }

                selectProfileTab("background");
                //selectProfileTab("posts")
            </script>
        </div>

    {% else %}
        No user with name {{ profileUsername }} found.
    {% endif %}
    -->

{% endblock %}
