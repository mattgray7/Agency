{% extends "base.html" %}

{% block content %}
{% load static %}
<link href="{% static "/AgencyApp/css/image.css" %}" rel="stylesheet" type="text/css" media="all" />
<link href="{% static "/AgencyApp/js/image/resources/jquery.selectareas.css" %}" media="screen" rel="stylesheet" type="text/css" />
<script src="{% static "/AgencyApp/js/image/jquery.selectareas.js" %}"></script>
<script type="text/javascript" src="{% static "/AgencyApp/js/image/image.js" %}"></script>
<script type="text/javascript" src="{% static "/AgencyApp/js/post/post.js" %}"></script>
<script>
    var projectTabs = ["roles", "jobs", "events"];
    var activeTab = "roles";
    var projectPicture;
    var projectSubFormPicture;

    function deletePostFromDB(postID, postType){
        $.ajax({
            url : "/ajax/deletePostFromDB/",
            data : {"postID": postID, "postType": postType},
            type : 'POST',
            dataType: "json",
            success : function(data) {
                if(!data["success"]){
                    console.log("failure, " + data["errors"]);
                }
            }
        });
    }

    function isElementListEmpty(listType){
        var listEmpty = false;
        if(listType == "roles"){
            {% if not roles %}
                listEmpty = true;
            {% endif %}
        }else if(listType == "jobs"){
            {% if not jobs %}
                listEmpty = true;
            {% endif %}
        }else if(listType == "events"){
            {% if not events %}
                listEmpty = true;
            {% endif %}
        }
        return listEmpty;
    }

    function generateNewPostID(postType){
        $.ajax({
            url : "/ajax/getNewPostID/",
            data : {"postType": postType},
            type : 'POST',
            success : function(data) {
                newPostIDs[postType] = data["postID"]
            }
        });
    }

    function getNewPostID(postType){
        var nextID = newPostIDs[postType]
        generateNewPostID(postType)
        return nextID;
    }

    function getPictureURL(isProject){
        // Returns the URL to display in edit picture popup window. If one has been uploaded already, that one will be chosen, otherwise the existing picture will be chosen, otherwise the noPicture default is chosen
        var pictureURL = "";
        if(isProject){
            if(projectPicture != null){
                pictureURL = projectPicture.src
            }else{
                {% if post and post.postPicture and post.postPicture.url %}
                    pictureURL = '{{post.postPicture.url}}';
                {% endif %}
            }
        }else{
            if(projectSubFormPicture != null){
                pictureURL = projectSubFormPicture.src
            }
        }
        setDoesPictureExist(pictureURL)
        if(pictureURL.length === 0){
            pictureURL = "{{images.noPicture}}";
        }
        return pictureURL;
    }

    function updatePictureObjects(isProject){
        // Set the picture object and whichever picture object was just updated
        if(isProject){
            projectPicture = newPicture;
        }else{
            projectSubFormPicture = newPicture;
        }
    }

    function addEditImageContent(containerID, isProject, pictureURL){
        var pictureID = "editPostPicture";
        setPictureID(pictureID);
        setButtonLoadingGifURL("{{images.loading.mid}}");
        setDefaultImageURL("{{images.loading.light}}")

        // Set the onclick to include isProject
        var updatePictureButton = document.getElementById("updatePictureButton");
        if(updatePictureButton != null){
            updatePictureButton.onclick = function(){
                submitPictureForm('editPostPictureForm', isProject)
            };
        }

        // Set the pictureURL to display
        var addCrop = true;
        if(pictureURL == null){
            pictureURL = getPictureURL(isProject);
        }
        if(pictureURL === "{{post.postPicture.url}}" || pictureURL === "{{images.noPicture}}"){
            addCrop = false;
        }else{
            // Don't add crop for newly added photos
            for(var postID in newPostPictureURLs){
                if(pictureURL === newPostPictureURLs[postID]){
                    addCrop = false;
                }
            }
        }

        // Set newPicture to pictureURL and update projectPicture/projectSubFormPicture
        setNewPictureObject(pictureURL, addCrop)
        updatePictureObjects(isProject);

        imageInputDivID = pictureID + "Image";

        // Reset picture input value and remove previous change callbacks
        $("[id='" + imageInputDivID + "']").val("");
        $("[id='" + imageInputDivID + "']").off('change');

        // Add new callback for this window
        $("[id='" + imageInputDivID + "']").change(function(){
            if(this.value != null && this.value.length > 0){
                pictureExists = true;
                previewEditPicture(this, function(){
                    updatePictureObjects(isProject)
                });
            }else{
                var fallbackPictureURL = "";
               {% if not post or not post.postPicture or not post.postPicture.url %}
                    pictureExists = false;
                {% endif %}
                if(pictureURL.length > 0){
                    setNewPictureObject(pictureURL, addCrop)
                    updatePictureObjects(isProject);
                    loadImage(pictureURL, addCrop)
                    selectMainArea()
                }
            }
        });
    }

    function getProjectFormDict(){
        var postFields = {}
        var errors = {"required": []};

        {% if forms.project %}
            {% spaceless %}
            {% for field in forms.project %}
                var postField = createPostField('project', '{{field.name}}', '{{field.value}}', '{{field.label}}', '{{field}}', '{{field.errors}}')
                if(postField != null){
                    postFields[postField.name] = postField;
                }

                // Add any form errors to the error dict
                {% if field.errors %}
                    {% for error in field.errors %}
                        var errorString = '{{error}}';
                        var fieldDisplayName = postField.label.replace("*", "");

                        // Want to group all fields with the same error
                        if(errorString ===  "This field is required."){
                            errors["required"].push(fieldDisplayName);
                        }
                    {% endfor %}
                {% endif %}
            {% endfor %}
            {% endspaceless %}

            // Add csrf token
            var csrfField = {"name": "csrf_token", "input": "{% csrf_token %}", "hidden": true};
            postFields['csrf_token'] = csrfField;

            // Add cancel button with onclick
            var cancelButton = {'name': 'cancelButton', 'onclick': 'redirectToPost("{{post.postID}}");', "hidden": true};
            postFields['cancelButton'] = cancelButton;

            // Add create/update button with onclick
            var createButton = {'name': 'createButton', 'onclickFunction': 'submitProjectForm', "hidden": true};
            postFields['createButton'] = createButton;

            if(errors["required"].length > 0){
                postFields["errors"] = errors;
            }

            postFields["newPost"] = true;
        {% endif %}
        return postFields;
    }

    function getExistingFormDict(postID, postType, loadSuccessCallback){
        var postData;
        if(postID != null && postID.length > 0){
            $.ajax({
                url : "/ajax/getPostData/",
                data : {"postID": postID},
                type : 'POST',
                dataType: "json",
                success : function(data) {
                    if(data["success"]){
                        // If a new picture has been added and page has not been refreshed, need to set picURl to temp value (browser won't update image at same path)
                        var newPictureURL = newPostPictureURLs[postID];
                        if(newPictureURL != null){
                            data["postData"]["postPicture"] = newPictureURL
                        }
                        var formDict;
                        if(postType === "roles"){
                            formDict = getCastingFormDict(false, data["postData"])
                        }else if(postType === "jobs"){
                            formDict = getWorkFormDict(false, data["postData"])
                        }
                        loadSuccessCallback(formDict);
                    }
                }
            });
        }
    }

    function getCastingFormDict(newPost, existingPostData){
        var postFields = {}
        {% if forms.role %}
            {% spaceless %}
                {% for field in forms.role %}
                    addPostField(postFields, "casting", '{{field.name}}', '{{field.value}}', '{{field.label}}', '{{field}}', existingPostData)
                {% endfor %}
            {% endspaceless %}

            // Add actor
            var actorField = {"username": "{{actor.username}}", "cleanName": "{{actor.cleanName}}"}
            {% if actor %}
                actorField["username"] = "{{actor.username}}";
                actorField["cleanName"] = "{{actor.cleanName}}";
                {% if actor.profilePicture %}
                    actorField.profilePictureURL = '{{actor.profilePicture.url}}';
                {% endif %}
            {% else %}
                actorField["username"] = null;
                actorField.profilePictureURL = '{{images.noProfilePicture}}';
            {% endif %}
            postFields["actor"] = actorField;

            // Add other required fields (csrf_token, onCancel, etc)
            postFields = modifyCastingPostFields(postFields, newPost, "roles");
        {% endif %}
        return postFields;
    }

    function getWorkFormDict(newPost, existingPostData){
        var postFields = {}
        {% if forms.job %}
            {% spaceless %}
                {% for field in forms.job %}
                    addPostField(postFields, "work", '{{field.name}}', '{{field.value}}', '{{field.label}}', '{{field}}', existingPostData)
                {% endfor %}
            {% endspaceless %}

            // Add actor
            var workerField = {"username": "{{worker.username}}", "cleanName": "{{worker.cleanName}}"}
            {% if actor %}
                workerField["username"] = "{{worker.username}}";
                workerField["cleanName"] = "{{worker.cleanName}}";
                {% if worker.profilePicture %}
                    workerField.profilePictureURL = '{{worker.profilePicture.url}}';
                {% endif %}
            {% else %}
                workerField["username"] = null;
                workerField.profilePictureURL = '{{images.noProfilePicture}}';
            {% endif %}
            postFields["worker"] = workerField;

            // Add other required fields (csrf_token, onCancel, etc)
            postFields = modifyCastingPostFields(postFields, newPost, "jobs");
        {% endif %}
        return postFields;
    }

    function addPostField(targetList, postType, name, value, label, input, existingValues){
        // Either get value from context for new posts, or existingPostData for existing posts
        if(existingValues != null){
            var tempValue = existingValues[name];
            if(tempValue != null && tempValue.length > 0 && tempValue != "None"){
                value = tempValue;
            }
        }

        if(value === "None"){
            value = "";
        }

        // Create the postField for this field and add it to the dict, indexed by field name
        var postField = createPostField(postType, name, value, label, input)
        if(postField != null){
            targetList[postField.name] = postField;
        }
    }

    // Adds the necessary casting post fields to the postFields dict
    function modifyCastingPostFields(postFields, newPost, postType){
            // Add project
            var projectField = {"name": "project"}
            {% if post and post.title %}
                projectField.title  = '{{post.title}}';
                projectField.projectID = '{{post.postID}}';
            {% endif %}
            postFields["project"] = projectField

            // Add csrf token
            var csrfField = {"name": "csrf_token", "input": "{% csrf_token %}", "hidden": true};
            postFields['csrf_token'] = csrfField;

            // Add cancel button with onclick
            var editOnclick;
            if(newPost){
                editOnclick = 'toggleExpandNewForm("shrink", "' + postType + '");'
            }else{
                editOnclick = 'toggleExpandExistingForm("shrink", "' + postType + '");'
            }
            var cancelButton = {'name': 'cancelButton', 'onclick': editOnclick, "hidden": true};
            postFields['cancelButton'] = cancelButton;

            // Add create/update button with onclick
            var createButton = {'name': 'createButton', 'onclickFunction': 'submitProjectSubForm', "hidden": true};
            postFields['createButton'] = createButton;

            postFields["newPost"] = newPost;
            return postFields;
    }

    function createPostField(postType, name, value, label, input){
            var save = true;
            var postField = {"name": name, "value": value, "hidden": false, "label": label, 'input': input}
            if(input.indexOf('hidden') >= 0){
                postField.hidden = true;
            }

            var statusOptions;
            {% if statusOptions %}
                statusOptions = {{ statusOptions|safe }}
            {% endif %}

            var selectFields;
            {% if selectFields %};
                selectFields = {{ selectFields|safe }};
            {% endif %}


            if(postField.name == "projectID"){
                postField.value = "{{post.projectID}}";
            }else if(postField.name == "postID" && (value == null || value.length === 0)){
                if(postType != 'project'){
                    postField.value = getNewPostID(postType);
                }else{
                    postField.value = '{{post.postID}}';
                }
            }else if(postField.name == "postPicture"){
                var isProject = false;
                if(postType === "project"){
                    isProject = true;
                    {% if post.postPicture %}
                        postField.value = "{{post.postPicture.url}}";
                    {% else %}
                        postField.value = "{{images.noPicture}}";
                    {% endif %}
                }else if(value == null || value.length === 0){
                    postField.value = "{{images.noPicture}}";
                }
                postField.editOnclick = "toggleEditPicturePopup('show', " + isProject + ", '" + postField.value + "')";
            }else if(postField.name == "paid"){
                var currentInput = postField.input;
                var paidDescription = '{{post.paidDescription}}'
                if(paidDescription === "None"){
                    paidDescription = ''
                }
                postField.input = "<div style='position: relative; margin-top: -5px;'>" + currentInput + "<div style='position: absolute; top: 0; right: 0; margin-top: 6px; width: 90%; min-width: 180px; text-align: right;'><div style='position: relative;'> <div style='position: absolute; left: 0;' class='editPostLabelPanel'>Specify </div><div style='position: absolute; left: 0; right: 0; margin-right: 3px; margin-left: 68px; margin-top: -3px;'><input type='text' name='paidDescription' value='" + paidDescription + "' style='display: inline; margin-top: -10px;'></div></div></div>"
            }else if(postField.name === "paidDescription"){
                // Paid description will be on same line as paid
                save = false;
            }else if(postField.name === "status"){
                var options = [];
                if("roles" in statusOptions && postType == "casting"){
                    options = {{ statusOptions.roles|safe }}
                }else if("jobs" in statusOptions && postType == "work"){
                    options = {{ statusOptions.jobs|safe }}
                }else{
                    options = {{ statusOptions.projects|safe }}
                }
                postField.options = options;
            }else if(postField.name == "description"){
                postField.numRows = 20;
                if(postField.value.length <= 0 || postField.value === "None"){
                    postField.value = "";
                }
                if(activeTab === "roles"){
                    postField["placeholder"] = "John is a charismatic father of 2 who loves his dogs."
                }else if(activeTab === "jobs"){
                    postField["placeholder"] = 'The hiree must be able to handle all camera operations for all set days. They will be compensated at an hourly rate, with potential for reshoots after primary production.';
                }else{
                    //project
                    postField["placeholder"] = "The Great Gatsby is a tale of love and loss. We will be shooting it over the next 3 weeks to create a short ode to the F Scott Fitzgerald classic."
                }
            }else if(postField.name == "poster"){
                postField.value = "{{ request.user.username }}"
                postField.input = postField.input.replace('name="poster"', 'name="poster" value="' + postField.value + '"')
            }else if(postField.name == "startDate" || postField.name == "endDate"){
                postField.input = postField.input.replace('type="text"', 'type="date"')
                {% if postField.name == "startDate" %}
                    postField.value = currentDateString
                {% else %}
                    postField.value = tomorrowDateString;
                {% endif %}
            }else if(selectFields != null){
                var roleSelectFields = {{ selectFields.roles.names|safe }};
                var jobSelectFields = {{ selectFields.jobs.names|safe }}
                if(roleSelectFields.indexOf(name) >= 0 && activeTab == "roles"){
                    {% if selectFields.roles.options %}
                        var options = {{ selectFields.roles.options|safe }}
                        postField.options = options[postField.name]
                    {% endif %}
                }else if(jobSelectFields.indexOf(name) >= 0 && activeTab == "jobs"){
                    {% if selectFields.jobs.options %}
                        var options = {{ selectFields.jobs.options|safe }}
                        postField.options = options[postField.name]
                    {% endif %}
                }else{
                    //project
                    var projectSelectFields = {{ selectFields.projects.names|safe }};
                    {% if selectFields.projects.options %}
                        var options = {{ selectFields.projects.options|safe }}
                        postField.options = options[postField.name]
                    {% endif %}
                }
            }
            if(save){
                // If value was added but it's not in input, add it (TODO change value in input if it is already there)
                if(postField.input.indexOf("value=") < 0 && postField.value.length > 0 && postField.value != "None"){
                    postField.input = postField.input.replace(">", " value='" + postField.value + "'>")
                }
                return postField;
            }
        return null;
    }

    function submitProjectForm(formName){
        // Set the status from the select bar in the form
        var statusDiv = document.getElementById("statusSelectBarProject");
        if(statusDiv != null){
            document.getElementById("statusSelectInputProject").value = statusDiv.value;
        }

        // Set values of all other select fields
        {% if selectFields.projects.names %}
            {% for name in selectFields.projects.names %}
                var selectDiv = document.getElementById('{{name}}SelectBarProject')
                if(selectDiv != null){
                    document.getElementById('{{name}}SelectInputProject').value = selectDiv.value;
                }
            {% endfor %}
        {% endif %}

        // Submit the form
        var form = document.getElementById(formName)
        if(form != null){
            return form.submit();
        }
    }

    var newPostPictureURLs = {}
    function submitProjectSubForm(formName, edit){
        // Submits the form while adding values of select bars with id '{{name}}SelectBar' to form input '{{name}}SelectInput'
        var statusDiv = document.getElementById("statusSelectBar");
        if(statusDiv != null){
            // Set the status from the select bar in the form
            document.getElementById("statusSelectInput").value = statusDiv.value;
        }

        var ajaxURL;
        if(activeTab === "roles"){
            ajaxURL = "/ajax/createNewCastingPost/";
            {% if selectFields.roles.names %}
                {% for name in selectFields.roles.names %}
                    var selectDiv = document.getElementById('{{name}}SelectBar')
                    if(selectDiv != null){
                        document.getElementById('{{name}}SelectInput').value = selectDiv.value;
                    }
                {% endfor %}
            {% endif %}
        }else if(activeTab === "jobs"){
            ajaxURL = "/ajax/createNewWorkPost/";
            {% if selectFields.jobs.names %}
                {% for name in selectFields.jobs.names %}
                    var selectDiv = document.getElementById('{{name}}SelectBar')
                    if(selectDiv != null){
                        document.getElementById('{{name}}SelectInput').value = selectDiv.value;
                    }
                {% endfor %}
            {% endif %}
        }
        if(edit){
            ajaxURL = "/ajax/editExistingPost/";
        }

        var form = document.getElementById(formName)
        if(form != null){
            $.ajax({
                url : ajaxURL,
                data : $("[id='" + formName + "']").serialize(),
                type : 'POST',
                dataType: "json",
                success : function(data) {
                    if(data["success"]){
                        var nextPic = data["pictureURL"];
                        if(nextPic == null && currentBaseFormPicture != null){
                            // currentBaseFormPicture set in image.js
                            nextPic = currentBaseFormPicture;
                        }

                        newPostPictureURLs[data["postID"]] = nextPic;
                        addNewPostToExistingList(form, nextPic, edit);
                        if(edit){
                            toggleExpandExistingForm("shrink", nextPic, edit, function(){selectProjectTab(activeTab)})
                        }else{
                            toggleExpandNewForm("shrink", activeTab, function(){selectProjectTab(activeTab)})
                        }
                    }else{
                        if(data["errors"]){
                            errorRow = document.getElementById("formErrorRow");
                            if(errorRow != null){
                                errorRow.innerHTML = "<td colspan='3'>" + getErrorPanel(data["errors"]) + "</td>";
                            }
                            newFormDiv = document.getElementById("insertNewFormDiv")
                            newFormDiv.style.height = "1470px";
                        }
                    }
                }
            });
        }
    }

    function createSingleRoleDict(dataForm, imageURL){
        var newPost = {"actor": {}, "post": {"postID": {'value': dataForm.postID.value, 'hidden': true},
                                             "characterName": {'value': dataForm.characterName.value, 'hidden': false},
                                             "startDate": {'value': 'Start: ' + dataForm.startDate.value, 'hidden': false},
                                             "endDate": {'value': 'End: ' + dataForm.endDate.value, 'hidden': false},
                                             "hoursPerWeek": {'value': 'Hours/week: ' + dataForm.hoursPerWeek.value, 'hidden': false},
                                             "paid": {'value': dataForm.paid.value , "hidden": false},
                                             "title": {'value': dataForm.title.value, 'hidden': false},
                                             "gender": {'value': dataForm.gender.value, 'hidden': true},
                                             "status": {'value': dataForm.status.value, 'hidden': true},
                                             "postPicture": {"value": '{{images.noPicture}}', "hidden": false},
                                       }};

        // Explicitly set the image url of the new post
        if(imageURL != null && imageURL.length > 0){
            newPost["post"]["postPicture"]["value"] = imageURL;
        }

        // Add compensation info
        if(dataForm.paid.value && dataForm.paidDescription.value){
            newPost["post"]["paid"]["value"] = "Paid &#10004 - " + dataForm.paidDescription.value;
        }else if(dataForm.paid.value){
            newPost["post"]["paid"]["value"] = "Paid &#10004";
        }else if(dataForm.paidDescription.value){
            newPost["post"]["paid"]["value"] = "Unpaid - " + dataForm.paidDescription.value;
        }else{
            newPost["post"]["paid"]["value"] = "Unpaid";
        }
        return newPost;
    }

    function addNewPostToExistingList(postForm, imageURL, edit){
        if(roleEntries == null){
            roleEntries = getBrowseRolesDict();
        }
        var newPost = createSingleRoleDict(postForm, imageURL);
        if(edit){
            // Need to edit existing roleEntries list and find the post with the matching postID
            // Must iterate through all status', as we don't know the previous status if there was a status change
            for(status in roleEntries){
                if(roleEntries[status] != null){
                    for(var i=0; i < roleEntries[status].length; i++){
                        var existingPost = roleEntries[status][i]
                        if(postForm.postID.value === existingPost["post"]["postID"]["value"]){
                            // This is the matching post
                            if(status != newPost.post.status.value){
                                // A status change has occurred, so remove post from old status list and add to new status list
                                roleEntries[status].splice(i, 1)
                                roleEntries[newPost.post.status.value].push(newPost)
                            }else{
                                // No status change, just update the current post with the new data
                                roleEntries[newPost.post.status.value][i] = newPost;
                            }
                            break;
                        }
                    }
                }
            }
        }else{
            // Adding new element, so don't need to modify existing lists, just add new post
            roleEntries[newPost.post.status.value].push(newPost);
        }
    }

    function getNewElementForm(formType){
        var formString = "";
        if(formType === "roles"){
            formString += addCreateCastingPost(getCastingFormDict(true, null), "{{currentPageURL}}", "createCastingPostForm");
        }else if(formType === "jobs"){
            formString += addCreateWorkPost(getWorkFormDict(true, null), "{{currentPageURL}}", "createWorkPostForm");
        }else if(formType === "events"){
            return "events"
        }
        return formString;
    }

    function setExistingElementForm(formType, postID, elementContentDiv){
        var formString = "";
        if(formType === "roles"){
            var castingFormDict = getExistingFormDict(postID, formType, function(postFields){
                var newFormString = addCreateCastingPost(postFields, "{{currentPageURL}}", "createCastingPostForm");
                elementContentDiv.innerHTML = newFormString;
            })
        }else if(formType === "jobs"){
            var workFormDict = getExistingFormDict(postID, formType, function(postFields){
                var newFormString = addCreateWorkPost(postFields, "{{currentPageURL}}", "createWorkPostForm");
                elementContentDiv.innerHTML = newFormString;
            })
        }else if(formType === "events"){
            return "events"
        }
        return formString;
    }

    var expanded = false;
    var transitionSpeed = 350;
    var formHeights = {"roles": "1375px", "jobs": "1150px", "events": "1375px"}
    function toggleExpandNewForm(toggleType, panelType, shrinkAnimationFinishCallback){
        var newFormDiv = document.getElementById("insertNewFormDiv")
        var browsePostsDiv = document.getElementById("projectContentList")
        var filterBarDiv = document.getElementById("projectContentListHeader")
        if(newFormDiv == null || browsePostsDiv == null){
            return;
        }

        if(toggleType === "expand"){
            newFormDiv.style.visibility = "visible";
            $("#insertNewFormDiv").animate({marginTop: "0px", height: formHeights[panelType]}, transitionSpeed);

            //newFormDiv.style.border = "2px solid #000";
            // Optional: animate filter bar to shrink as opposed to just making invisible
            $("#projectContentListHeader").animate({marginTop: "0px", height: "0px"}, transitionSpeed);
            filterBarDiv.style.visibility = "hidden";
            browsePostsDiv.style.marginTop = "20px";
            newFormDiv.innerHTML = getNewElementForm(panelType);
            addElementStatusSelect(panelType);
            expanded = true;
        }else{
            $("#insertNewFormDiv").animate({marginTop: "0px", height: "0px"}, transitionSpeed, function(){newFormDiv.style.visibility = "hidden"});

            //newFormDiv.style.border = "2px solid #000";
            // Optional: animate filter bar to shrink as opposed to just making invisible
            $("#projectContentListHeader").animate({marginTop: "0px", height: "40px"}, transitionSpeed, function(){
                filterBarDiv.style.visibility = "visible";
                if(shrinkAnimationFinishCallback != null){
                    shrinkAnimationFinishCallback();
                }
            });
            browsePostsDiv.style.marginTop = "0px";
            newFormDiv.innerHTML = createAddNewButton(panelType);
            expanded = false;
        }
    }

    var currentExistingFormPostID = ''
    function toggleExpandExistingForm(toggleType, panelType, postID, shrinkAnimationFinishCallback){
        var editButton = document.getElementById("editPostButton_" + postID)
        var borderCover = document.getElementById("postPanelBorderCover_" + postID);
        var postPanel = document.getElementById("browseTablePost_" + postID);
        if(toggleType === "expand"){
            if(currentExistingFormPostID != ''){
                // Shrink existing panel and then expand new one
                return toggleExpandExistingForm("shrink", panelType, currentExistingFormPostID, function(){toggleExpandExistingForm("expand", panelType, postID)});
            }
            currentExistingFormPostID = postID;
            var postRow = $('[id=browseTablePost_' + postID + ']').closest('tr');
            var rowDiv = document.getElementById(postRow[0].id);
            if(rowDiv != null){
                // Create new row
                var newRow = document.createElement('tr');
                newRow.id = "insertExistingFormDivContainerRow"

                // Create new col with ful colspan
                var newCol = document.createElement('td');
                newCol.colSpan = tableColCount;

                // Create new form div to put in column
                var newFormDiv = document.createElement('div');
                newFormDiv.className = "browseTableForm";
                newFormDiv.id = "insertExistingFormDiv";
                newFormDiv.style.overflow = "hidden";
                newFormDiv.style.height = "0px";
                setExistingElementForm(panelType, postID, newFormDiv)

                // Add the div to col, col to row, and row after the parent row
                newCol.appendChild(newFormDiv)
                newRow.appendChild(newCol)
                rowDiv.parentNode.insertBefore(newRow, rowDiv.nextSibling);
                $("#insertExistingFormDiv").animate({marginTop: "0px", height: formHeights[panelType]}, transitionSpeed + 200);
            }

            // Change onclick of edit button to shrink form
            if(editButton != null){
                editButton.onclick = function(){
                    toggleExpandExistingForm("shrink", panelType, postID, shrinkAnimationFinishCallback);
                };
                editButton.innerHTML = "Hide";
            }

            // Change panel background to white
            if(postPanel != null){
                postPanel.style.background = "#FFF";
            }

            // Add border cover
            if(borderCover != null){
                borderCover.style.visibility = "visible";
            }
        }else{
            // Shrinking, so no post id is active
            currentExistingFormPostID = '';

            // Shrink the form and call any cleanup functions 
            $("#insertExistingFormDiv").animate({marginTop: "0px", height: "0px"}, transitionSpeed, function(){
                $("#insertExistingFormDivContainerRow").remove()

                // Add border cover
                if(borderCover != null){
                    borderCover.style.visibility = "hidden";
                }

                // Change panel background to white
                if(postPanel != null){
                    postPanel.style.background = "#efefef";
                }

                if(shrinkAnimationFinishCallback != null){
                    shrinkAnimationFinishCallback();
                }
            });

            // Change onclick of edit buttonback to expand form
            if(editButton != null){
                editButton.onclick = function(){
                    toggleExpandExistingForm("expand", panelType, postID);
                };
                editButton.innerHTML = "Edit";
            }

        }
    }

    function getSingularFromPlural(plural){
        if(plural.substring(plural.length-1, plural.length) == "s"){
            return plural.substring(0, plural.length-1);
        }
        return plural
    }

    function createAddNewButton(tabType){
        var buttonString = "";
        var expandType = "expand";
        if(expanded){
            expandType = "shrink";
        }

        buttonString += "<div id='addNewBrowseFormButton' class='addNewPostButton' onclick='toggleExpandNewForm(" + '"' + expandType + '", "' + tabType + '");' + "' style='position: relative; margin-top: 4px; margin-left: 4px;'> <div style='margin-top: -15px; position: absolute; top: 55%; margin-left: 7px;'><h3 style='font-weight: 300;'>Add</h3></div> <img src='{{images.plus}}' style='height: 23px; width: 23px; position:absolute; right: 6%; top: 12%;'></div>";
        
        return buttonString
    }
</script>

<script>
document.write('<div id="mainViewPanel" class="mainViewPanel" style="width: ')
tableColCount = getBrowseTableNumColumnsFromWindowSize();
document.write(getPanelInfoFromNumColumns(tableColCount)["mainViewPanelWidth"] + ';">');
</script>
    <div id="hiddenGrayPopupOverlay" class="hiddenGrayPopupOverlay" style="background: rgba(0,0,0,0); height:0%; width:0%; position: fixed; top:0; z-index: 3">
        <div style="position: relative; height: 100%;"><div id="selectProjectPanel" class="popupContentPanel" style="width: 80%; height: 400px; display: none; position: fixed; top: 10%; left: 10%;" onclick="toggleSelectProjectPopup('hide', 'asdasds');"></div></div>
        <div style="position: relative; height: 100%;">
            <div id="editPicturePanel" class="popupContentPanel" style="width: 400px; padding-bottom: 1.5em; display: none; position: fixed; top: 2%; left: 25%;">
                <center>
                <div id="backToProfileButton" style="width:170px; padding: 0em 0em 0em 0em; float: left; margin-top: 5px; margin-left: 5px;"><a onclick="toggleEditPicturePopup('hide');" class="noBorderButton" style="border: none; float: left; margin-left: 10px;">X</a></div>
                <br><br>
                    <h1> Add Picture </h1>
                <br>
                <center>
                    <div style='position: relative; width: 300px;'>
                        <div id="loadingPictureGrayOverlay" class="hiddenGrayPopupOverlay" style="background: rgba(0,0,0,0); height:0%; width:0%; position: absolute; margin-top: 6px; margin-left: 6px;top:0; z-index: 1000">
                            <img id='loadingGif' src='{{images.loading.light}}' style='height: 70px; width: 70px; display: none; margin-top: 50%; margin-left: 5%; z-index: 1001'></div>
                    </div>
                    <div id="editPostPictureDiv" class="editPostPictureDiv" style='width: 300px;'>
                    </div>
                </center>

                <form method="post" id="editPostPictureForm" enctype="multipart/form-data">
                    {% csrf_token %}
                    <div style='text-align: center; margin-left: 30px;'><input type='file' name='postPicture' id='editPostPictureImage'></div><br>
                    <input type='hidden' name='postID' value='{{post.postID}}'>
                    <input type='hidden' name='postType' value='{{postType}}'>

                    <table>
                        <tr>
                            {% if post and post.postPicture and post.postPicture.url %}
                                <td>
                                    <div id="removeButton" class="whiteButton blackHover" style="width:70px; height:28px; display:block;" onclick="removePicture();">
                                        <div style="margin-left: 5px; margin-top: 2px;">Remove</div>
                                    </div>
                                </td>
                            {% else %}
                                <td>
                                    <div id="skipButton" class="whiteButton blackHover" style="width:70px; height:28px; display: block;" onclick="toggleEditPicturePopup('hide');">
                                        <div style="margin-left: 5px; margin-top: 2px;">Cancel</div>
                                    </div>
                                </td>
                            {% endif %}
                            <td>
                                <div id="updatePictureButton" class="whiteButton blackHover" style="width: 70px; height:28px; position: relative; display: block;">
                                    <div style="margin-left: 5px; margin-top: 2px;">Update</div>
                                </div>
                            </td>
                        </tr>
                    </table>
                    <div id="cropInfoInputs"></div>
                </form>
            </div>
            </center>
        </div>
    </div>
    <div id="editPostPanel" class="editPostPanel">
        <div id="projectForm"></div>
    </div>
    <script>
        var projectFormDiv = document.getElementById("projectForm");
        if(projectFormDiv != null){
            var newForm = addCreateProjectPost(getProjectFormDict(), "{{currentPageURL}}", "createProjectPostForm");
            projectFormDiv.innerHTML = newForm;
        }
    </script>
    <table id='browseTableContainer' style="margin-top: 10px;">
            <tr>
                        <td colspan="3" >
                            <div style='position: relative; width: 100%; height: 55px;'>
                                <div class="projectTabButtonInactive" id="rolesButton" onclick="selectProjectTab('roles')" style="position: absolute; left: 0; margin-left: -1px;">
                                    Roles
                                    <div id="rolesBorderCover" class="profileTabBorderCover"></div>
                                </div>
                                <div class="projectTabButtonInactive" id="jobsButton" onclick="selectProjectTab('jobs')" style="position: absolute; left:33.8%;">
                                            Jobs
                                            <div id="jobsBorderCover" class="profileTabBorderCover"></div>
                                </div>
                                <div class="projectTabButtonInactive" id="eventsButton" onclick="selectProjectTab('events')" style="position: absolute; right: 0; margin-right: -8px;">
                                            Events
                                            <div id="eventsBorderCover" class="profileTabBorderCover"></div>
                                </div>



                            <!--<table style="width: 100%;">
                                <tr style="text-align: center">
                                    <td>
                                        <div class="projectTabButtonInactive" id="rolesButton" onclick="selectProjectTab('roles')" style="margin-left: -4px;">
                                            Roles
                                            <div id="rolesBorderCover" class="profileTabBorderCover"></div>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="projectTabButtonInactive" id="jobsButton" onclick="selectProjectTab('jobs')" style="margin-left: 0px;">
                                            Jobs
                                            <div id="jobsBorderCover" class="profileTabBorderCover"></div>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="projectTabButtonInactive" id="eventsButton" onclick="selectProjectTab('events')" style="margin-right: -12px;">
                                            Events
                                            <div id="eventsBorderCover" class="profileTabBorderCover"></div>
                                        </div>
                                    </td>
                                </tr>
                            </table>-->
                        </td>
            </tr>
            <tr>
                        <td colspan="3">
                            <div style="position: relative;">
                            <div id="projectContentPanel" class="projectContentPanel" style="margin-left: -1px; margin-right:-8px; min-height: 70px; ">
                                <!--<div id="addNewPanel" style="position: absolute; top: 0; left: 0; margin-top: 2px; margin-bottom: -10px; border: 2px solid #000; border-radius: 4px; width: 24.6%; text-align: center;">
                                    <script>
                                        {% if roles %}
                                            document.write(createAddNewButton("roles"));
                                        {% elif jobs %}
                                            document.write(createAddNewButton("jobs"));
                                        {% elif events}
                                            document.write(createAddNewButton("events"));
                                        {% endif %}
                                    </script>
                                </div>-->
                                <div style='height:5px;'></div>
                                <div id="projectContentListHeader" style="width: 99%; height: 40px; margin-left: 3px; background: rgba(0,0,0,0.1); border: 1px solid rgba(0,0,0,0.2); border-radius: 3px;">
                                    <script>
                                        {% if roles %}
                                            document.write(createAddNewButton("roles"));
                                        {% elif jobs %}
                                            document.write(createAddNewButton("jobs"));
                                        {% elif events %}
                                            document.write(createAddNewButton("events"));
                                        {% else %}
                                            document.write(createAddNewButton("roles"));
                                        {% endif %}
                                    </script>
                                </div>
                                <div style='height:5px;'></div>
                                <div id='insertNewFormDiv' style="border: 2px solid rgba(0,0,0,0.3); border-radius: 4px; visibility: hidden; background: #FFF;"></div>
                                <div id="projectContentList" style=" width: 100%; margin-left: 0px; min-height: 360px;">

                                </div>
                            </div>
                        </div>
                        </td>
            </tr>
        </table>
    </div>
</div>
<script>
    var newPostIDs = {"casting": null, "work": null, "event": null}
    for(postType in newPostIDs){
        generateNewPostID(postType)
    }

    function getEmptyListButton(listType){
        var contentString = "<div style='position: relative; margin-top: 20px;'><div id='addNewPanel' class='addNewPanel' style='height:0px; width: 99.5%; border: none; position: absolute; top:0; z-index: 2; margin-top: -13px;'></div><div style='width: 100%; height: 60px; text-align: center; position:absolute; top: 30%; left: -20%; background: #FFF;' ><h3 style='display: inline;'>No " + listType + " registered.</h3><div class='whiteButton blackHover' onclick='toggleExpandListPanel(" + '"expand", "' + listType + '", "vertical");' + "' style='position: absolute; left: 70%; margin-top: -12px; width: 22%;'> Add </div></div>"
        return contentString
    }

    var roleEntries;
    function getBrowseRolesDict(){
        if(roleEntries == null){
            var roleDict = {"Open": [], "Cast": [], "Opening soon": []};
            {% if roles %}
                {% for role in roles %}
                    var newRole = {"actor": {}, "post": {}};
                    {% if role.actor %}
                        newRole["actor"] = {"username": '{{role.actor.username}}', "cleanName": '{{role.actor.cleanName}}'}
                        {% if role.actor.profilePicture and role.actor.profilePicture.url %}
                            newRole["actor"]["profilePicture"] = '{{role.actor.profilePicture.url}}';
                        {% else %}
                            newRole["actor"]["profilePicture"] = '{{images.noProfilePicture}}';
                        {% endif %}
                    {% endif %}

                    {% if role.post %}
                        newRole["post"] = {"postID": {'value': '{{role.post.postID}}', 'hidden': true},
                                           "characterName": {'value': '{{role.post.characterName}}', 'hidden': false},
                                           "startDate": {'value': 'Start: {{role.post.startDate}}', 'hidden': false},
                                           "endDate": {'value': 'End: {{role.post.endDate}}', 'hidden': false},
                                           "hoursPerWeek": {'value': 'Hours/week: {{role.post.hoursPerWeek}}', 'hidden': false},
                                           "paid": {'value': '{{role.post.paid}}', "hidden": false},
                                           "title": {'value': '{{role.post.title}}', 'hidden': false},

                                           "gender": {'value': '{{role.post.gender}}', 'hidden': true},
                                           "status": {'value': '{{role.post.status}}', 'hidden': true},
                                           "postPicture": {"value": '{{images.noPicture}}', "hidden": false},
                                       };
                        {% if role.post.postPicture and role.post.postPicture.url %}
                            newRole["post"]["postPicture"]["value"] = '{{role.post.postPicture.url}}';
                        {% endif %}

                        {% if role.post.paid and role.post.paidDescription %}
                            newRole["post"]["paid"]["value"] = "Paid &#10004 - {{role.post.paidDescription}}";
                        {% elif role.post.paid %}
                            newRole["post"]["paid"]["value"] = "Paid &#10004";
                        {% elif role.post.paidDescription %}
                            newRole["post"]["paid"]["value"] = "Unpaid - {{role.post.paidDescription}}";
                        {% else %}
                            newRole["post"]["paid"]["value"] = "Unpaid";
                        {% endif %}

                    if('{{role.post.status}}' in roleDict){
                        roleDict['{{role.post.status}}'].push(newRole);
                    };
                    {% endif %}
                {% endfor %}
            {% endif %}
            roleEntries = roleDict;
        }
        return roleEntries;
    }

    var jobEntries;
    function getBrowseJobsDict(){
        if(jobEntries == null){
            var jobDict = {"Open": [], "Opening soon": [], "Filled": []};
            {% if jobs %}
                {% for job in jobs %}
                    var newJob = {"user": {}, "post": {}};
                    {% if job.worker %}
                        newJob["user"] = {"username": '{{job.user.username}}', "cleanName": '{{job.user.cleanName}}'}
                        {% if role.actor.profilePicture and role.actor.profilePicture.url %}
                            newJob["user"]["profilePicture"] = '{{job.user.profilePicture.url}}';
                        {% else %}
                            newJob["user"]["profilePicture"] = '{{images.noProfilePicture}}';
                        {% endif %}
                    {% endif %}

                    {% if job.post %}
                        newJob["post"] = {"postID": {'value': '{{job.post.postID}}', 'hidden': true},
                                           "profession": {'value': '{{job.post.profession}}', 'hidden': false},
                                           "startDate": {'value': 'Start: {{job.post.startDate}}', 'hidden': false},
                                           "endDate": {'value': 'End: {{job.post.endDate}}', 'hidden': false},
                                           "hoursPerWeek": {'value': 'Hours/week: {{job.post.hoursPerWeek}}', 'hidden': false},
                                           "paid": {'value': '{{job.post.paid}}', "hidden": false},
                                           "title": {'value': '{{job.post.title}}', 'hidden': false},
                                           "location": {'value': '{{job.post.location}}', 'hidden': true},
                                           "status": {'value': '{{job.post.status}}', 'hidden': true},
                                           "postPicture": {"value": '{{images.noPicture}}', "hidden": false},
                                       };
                        {% if job.post.postPicture and job.post.postPicture.url %}
                            newJob["post"]["postPicture"]["value"] = '{{job.post.postPicture.url}}';
                        {% endif %}

                        {% if job.post.paid and job.post.paidDescription %}
                            newJob["post"]["paid"]["value"] = "Paid &#10004 - {{job.post.paidDescription}}";
                        {% elif job.post.paid %}
                            newJob["post"]["paid"]["value"] = "Paid &#10004";
                        {% elif job.post.paidDescription %}
                            newJob["post"]["paid"]["value"] = "Unpaid - {{job.post.paidDescription}}";
                        {% else %}
                            newJob["post"]["paid"]["value"] = "Unpaid";
                        {% endif %}

                    if('{{job.post.status}}' in jobDict){
                        jobDict['{{job.post.status}}'].push(newJob);
                    };
                    {% endif %}
                {% endfor %}
            {% endif %}
            jobEntries = jobDict;
        }
        return jobEntries;
    }

    var eventEntries;
    function selectProjectTab(tabType){
        for(var i=0; i < projectTabs.length; i++){
            var buttonId = projectTabs[i] + "Button";
            var borderCoverId = projectTabs[i] + "BorderCover";
            var projectButtonDiv = document.getElementById(buttonId);
            var projectButtonBorderCoverDiv = document.getElementById(borderCoverId)
            if(projectButtonDiv != null && projectButtonBorderCoverDiv != null){
                if(projectTabs[i] === tabType){
                    projectButtonDiv.className = "projectTabButtonActive";
                    activeTab = tabType;
                    /*if(isElementListEmpty(tabType)){
                        var projectContentPanel = document.getElementById("projectContentPanel");
                        if(projectContentPanel != null){
                            projectContentPanel.innerHTML = getEmptyListButton(tabType);
                            $("#projectContentPanel").animate({marginTop: "-13px", height: "70px"}, 300);
                            
                        }
                    }else{
                        document.getElementById("addNewPanel").innerHTML = createAddNewButton(tabType);
                    }*/
                } else {
                    projectButtonDiv.className = "projectTabButtonInactive";        
                }
            }
        }

        // Change the onclick of the addNew button
        var addNewButton = document.getElementById("addNewBrowseFormButton");
        if(addNewButton != null){
            addNewButton.onclick = function(){
                toggleExpandNewForm("expand", activeTab);
            }
        }

        var entries;
        var sectionOrder;
        var titleFieldName;
        if(tabType === "roles"){
            entries = getBrowseRolesDict();
            sectionOrder = ["Open", "Opening soon", "Cast"];
            titleFieldName = "characterName";
        }else if(tabType == "jobs"){
            entries = getBrowseJobsDict();
            sectionOrder = ["Open", "Opening soon", "Filled"];
            titleFieldName = "profession";
        }else if(tabType == "events"){
            selectEvents();
        }
        var table = createBrowseTable(tabType, entries, sectionOrder, true, titleFieldName)
        var contentDiv = document.getElementById("projectContentList")
        if(contentDiv != null){
            contentDiv.innerHTML = table;
        }
        $(window).resize(function () {
            resizeBrowseTable(function(){
                document.getElementById("browseTable").style.width = tableColCount * 300 + "px";
                selectProjectTab(activeTab);
            });
        });
    }

    /*
    function selectEvents(){
        var listDiv = document.getElementById("projectContentList");
        var contentString = "";
        if(listDiv != null){
            {% if events %}
                contentString += "<table><tr>";
                {% for eventObj in events %}
                    contentString += "<td class='projectContentListElement grayBackground grayHover' onclick='redirectToPost(" + '"{{eventObj.post.postID}}");' + "'>";
                    // eventPic
                    contentString += "<div class='projectContentListElementPicturePanel'><div class='projectContentListElementPicture'>";
                    {% if eventObj.post.postPicture %}
                        contentString += '<img src="{{ eventObj.post.postPicture.url }}" style="max-width: 150px; max-height:150px;"/>'
                    {% else %}
                        contentString += '<img src="{{images.noPicture}}" style="width: 150px; max-height: 150px;">';
                    {% endif %}
                    contentString += "</div></div><br>";
                    contentString += "<div class='projectContentListElementText'><h2>{{eventObj.post.title}}</h2><h3>{{eventObj.post.date}}<br>Location: {{eventObj.post.location}}</h3><p>{{eventObj.post.description}}</p></div>";
                    contentString += "</td>";
                {% endfor %}
                contentString += "</tr></table>"
            {% endif %}
            listDiv.innerHTML = contentString
        }
    }*/

    function submitForm(formName){
        if(formName == null){
            formName = "editContentForm";
        }
        var statusDiv = document.getElementById("statusSelect");
        if(statusDiv != null){
            // Set the status from the select bar in the form
            document.getElementById("id_status").value = statusDiv.value;
        }
        var form = document.getElementById(formName)
        if(form != null){
            return form.submit()
        }
    }

    selectProjectTab("roles")
    var statusSelectDiv = document.getElementById("statusSelectDiv");
    if(statusSelectDiv != null){
        var options = null;
        {% if statusOptions.projects %}
            options = {{statusOptions.projects|safe}};
        {% endif %}
        addStatusBar("statusSelectDiv", "statusSelect", "{{ post.status }}", "editContentForm", options)
    }

    function addElementStatusSelect(elementType){
        var elementStatusSelectDiv = document.getElementById("elementStatusSelectDiv");
        if(elementStatusSelectDiv != null){
            var options = null;
            if(elementType == "roles"){
                {% if statusOptions.roles %}
                    options = {{statusOptions.roles|safe}}
                {% endif %}
            }else if(elementType == "jobs"){
                {% if statusOptions.jobs %}
                    options = {{statusOptions.jobs|safe}}
                {% endif %}
            }else if(elementType == "events"){
                {% if statusOptions.events %}
                    options = {{statusOptions.events|safe}}
                {% endif %}
            }
            addStatusBar("elementStatusSelectDiv", "elementStatusSelect", "Open", "addNewElementForm", options)
        }
    }

</script>
{% endblock %}
