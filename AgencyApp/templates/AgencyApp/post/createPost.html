{% extends "base.html" %}

{% block content %}
<script>
	$( document ).ready(function() {
		$( ".datepicker" ).datepicker({
			// TODO add hour to date
			changeMonth: true,
			changeYear: true,
			yearRange: "2017:2019",
			dateFormat: 'yy-mm-dd' 
		});
	});

	function deletePostFromDB(postID, postType){
		$.ajax({
			url : "/ajax/deletePostFromDB/",
			data : {"postID": postID, "postType": postType},
			type : 'POST',
			dataType: "json",
			success : function(data) {
				if(!data["success"]){
					console.log("failure, " + data["errors"]);
				}
			}
		});
	}
</script>

<div id="mainViewPanel" class="mainViewPanel">
	<div id="postPanel" class="postPanel">
		<table style="width:99%; height: 400px;">
					<tr>
						<td style="min-width: 400px;">
							<div id="postPicturePanel" class="postPicture hoverContainer" style="width: 100%; height: 100%">
								<div style="max-width:100%; max-height:100%; min-width: 100%; min-height: 100%; background: #000; border: 1px solid #FFF; border-radius:3px; position: relative; overflow: hidden;">
									<div id="postPicture" style="padding: 3em 0em 0em 0em">
										{% if post.postPicture %}
											<img src="{{ post.postPicture.url }}" style="min-width: 100%; max-width:100%; max-height:100%;"/>
										{% else %}
											<img src="{{ images.noPicture }}" style="min-width: 100%; max-width:100%; max-height:100%;"/>
										{% endif %}
									</div>
									<div class="grayAlphaOverlay"></div>
									<div id="editPictureFilePanel" class="editPictureFilePanel" style="position: absolute; bottom: -100px;">
										<form method="post" id="editPictureForm" action="{{ currentPageURL }}" enctype="multipart/form-data" style="margin-left: 3px;">
											{% csrf_token %} 
											{% for field in form %}
												{% if field.name == "postPicture" %}
											    	<h3>New picture: {{ field }}</h3>
											    {% endif %}
											{% endfor %}
										</form>
											<table style="width: 100%; margin-left: -2px;">
												<tr>
													<td >
														<div class="whiteButton blackHover" onclick="toggleEditPictureFilePanel('hide');" style="padding: 0.5em 0em 0.5em 0em; width: 99%; text-align: center;">Cancel</div>
													</td>
													<td>
														<div class="whiteButton blackHover" style="padding: 0.5em 0em 0.5em 0em; width: 99%; text-align: center">Update</div>
													</td>
												</tr>
											</table>
									</div>
									<div style="text-align: center; position: absolute; top: 47%; width: 100%; display: block;">
					  					<div class="editPictureHoverButton" style="">
											<a onclick="toggleEditPictureFilePanel('display');">Update </a>
										</div>
					  				</div>
								</div>
							</div>
						</td>
						<td style="min-width: 400px;">
							<div style="width: 99%; height: 98%; background: #FFF; max-width:100%; max-height:99%; min-width: 100%; min-height: 99%; border: 1px solid #FFF; border-radius:3px; margin-left: 10px;">
								<form method="post" id="editContentForm" action="{{ currentPageURL }}" enctype="multipart/form-data">
									{% csrf_token %} 
									{% for field in form.visible_fields %}
										{% if field.name != "postPicture"%}
											<h3>{{field.label}}: {{ field }}</h3>
										{% endif %}
									{% endfor %}
								</form>

							</div>
						</td>

					</tr>
		</table>
	</div>
</div>
<script>
	function toggleEditPictureFilePanel(toggleType){
		var form = document.getElementById
		var pictureFilePanel = document.getElementById("editPictureFilePanel");
		if(pictureFilePanel != null){
			if(toggleType == "display"){
				console.log("displaying")
				$('.editPictureFilePanel').animate({bottom: "0"}, 200); 
			}else{
				$('.editPictureFilePanel').animate({bottom: "-100"}, 200); 
			}
		}
	}
</script>





	{% if errors %}
		<ul>
			{% for error in errors %}
				<li>{{ error }}</li>
			{% endfor %}
		</ul>
	{% endif %}

	<h3>
		{% if isEvent %}
			{% if post.title %}
				Update event
			{% else %}
				Create event
			{% endif %}
		{% elif isProject %}
			{% if post.title %}
				Update project
			{% else %}
				Create project
			{% endif %}
		{% elif isCollaboration %}
			{% if post.title %}
				Update collaboration post
			{% else %}
				Create collaboration post
			{% endif %}
		{% elif isWork %}
			{% if post.title %}
				Update work post
			{% else %}
				Create work post
			{% endif %}
		{% elif isCasting %}
			{% if post.title %}
				Update casting post
			{% else %}
				Create casting post
			{% endif %}
		{% endif %}
	</h3>

	{% if post.postPicture %}
		<div id="postPicture">
			<img src="{{ post.postPicture.url }}" height="150px" width="120px"/>
		</div>
	{% endif %}

	{% if post.title %}
		<form method='post' action="/post/edit/{{post.postID}}/" name='createForm' id='createForm' enctype="multipart/form-data" onsubmit="return submitForm()">
	{% else %}
		{% if isEvent %}
			<form method='post' action="/post/create/event/" name='createForm' id='createForm' enctype="multipart/form-data" onsubmit="return submitForm()">
		{% elif isProject %}
			<form method='post' action="/post/create/project/" name='createForm' id='createForm' enctype="multipart/form-data" onsubmit="return submitForm()">
		{% elif isCollaboration %}
			<form method='post' action="/post/create/collaboration/" name='createForm' id='createForm' enctype="multipart/form-data" onsubmit="return submitForm()">
		{% elif isWork %}
			<form method='post' action="/post/create/work/" name='createForm' id='createForm' enctype="multipart/form-data" onsubmit="return submitForm()">
		{% elif isCasting %}
			<form method='post' action="/post/create/casting/" name='createForm' id='createForm' enctype="multipart/form-data" onsubmit="return submitForm()">
		{% endif %}
	{% endif %}
	{% csrf_token %}
	{{ form.as_p }}
	{% if not hideStatus %}
		Status: <div id="statusDiv" style="display:inline"></div><br><br>
	{% endif %}

	{% if isCasting %}
			<script>
			function toggleActorDescriptions(){
				// Create input list
				var tagInputs = document.getElementsByTagName("input")
				var selectInputs = document.getElementsByTagName("select");
				var inputs = []
				for(var i=0; i < tagInputs.length; i++){
					inputs.push(tagInputs[i]);
				}
				for(var i=0; i < selectInputs.length; i++){
					inputs.push(selectInputs[i]);
				}

				// toggle the enable
				for(var i=0; i < inputs.length; i++){
					var currentInput = inputs[i]
					if(currentInput.id.substring(0, 10) == "attributes"){
						if(currentInput.disabled){
							currentInput.disabled = false;
							document.getElementById("physicalAttributesEnabledDiv").innerHTML = "<input type='hidden' name='descriptionEnabled' value='True' />";
							document.getElementById("physicalAttributesDivLabel").innerHTML = '<font color="black">Physical attributes</font>';
						}else{
							currentInput.disabled = true;
							document.getElementById("physicalAttributesEnabledDiv").innerHTML = "<input type='hidden' name='descriptionEnabled' value='False' />";
							document.getElementById("physicalAttributesDivLabel").innerHTML = '<font color="gray">Physical attributes</font>';
						}
					}
				}
			}
			</script>
			<br>
			<h5 style="display:inline;"> You can specify the physical characteristics of the role, which we can use to notify actors with matching traits of your casting post. Your post will still be visible without physical criteria enabled.</h5>
			<br>
			Enable physical attributes
			{% if descriptionEnabled %}
				<input type="checkbox" onclick="toggleActorDescriptions();" value="Enable physical criteria" checked/>
			{% else %}
				<input type="checkbox" onclick="toggleActorDescriptions();" value="Enable physical criteria"/>
			{% endif %}
			<br><br>

			<div id="physicalAttributesDiv">
				<h4 style="display:inline;">
					<div id="physicalAttributesDivLabel"><font color="gray">Physical attributes</font></div>
				</h4>
				<table>
					<script>
					var attributeDivIdList = [];
					</script>
					{% for attribute in attributes %}
						<tr><td>
							<script>
							function changeAttributeBool(attributeName, newBoolValue){
								var attributeInputDiv = document.getElementById(attributeName + "BoolDiv");
								if(attributeInputDiv != null){
									attributeInputDiv.innerHTML = "<input type='hidden' name='attributes.{{attribute.name}}' value='" + newBoolValue + "'>"
								}
							}
							</script>
							{{attribute.name}}: 
							{% if attribute.value == True or attribute.value == "True" %}
								<div id="{{attribute.name}}BoolDiv"></div>
								<input type='checkbox' value='{{attribute.value}}' id="attributes.{{attribute.name}}" name='{{attribute.name}}' disabled='disabled' onclick='changeAttributeBool("{{attribute.name}}", "False");' checked>
							{% elif attribute.value == False or attribute.value == "False" %}
								<div id="{{attribute.name}}BoolDiv"></div>
								<input type='checkbox' value='{{attribute.value}}' id="attributes.{{attribute.name}}" name='{{attribute.name}}' disabled='disabled' onclick='changeAttributeBool("{{attribute.name}}", "True");' >
							{% else %}
								{% if attribute.options %}
									<div id="attributes.{{attribute.name}}Div"></div>
								{% elif attribute.value and attribute.value != "None" %}
									<input type='text' value='{{attribute.value}}' id="attributes.{{attribute.name}}" name="attributes.{{attribute.name}}" disabled='disabled'>
								{% else %}
									<input type='text' value='' id="attributes.{{attribute.name}}" name="attributes.{{attribute.name}}" disabled='disabled'>
								{% endif %}
							{% endif %}
							</td></tr>
					{% endfor %}

				</table>
				<div id="physicalAttributesEnabledDiv" style="display:inline";>
					<input type='hidden' name='descriptionEnabled' value='{{ descriptionEnabled }}' />
				</div>
			</div>

	{% elif isWork %}
		<div id='professionListDiv'></div><br>
	{% elif isCollaboration %}
		<div id='collaboratorRoleDiv'></div><br>
	{% endif %}

	{% if post.title %}
		<input type="submit" value="Update" />
	{% else %}
		<input type="submit" value="Create" />
	{% endif %}
	</form>
	<div id="cancelButton" class="button"><div id="cancelButtonLabel"></div>
</div>

<script>
		/*$(document).ready(function(){
			// run a deconstructor to delete a post from the db if user navigates away from this page without canceling
			toolbarDeconstructorFunctions.push(function(){
				{% if not post.record.title %}
					// New record, need to delete
					deletePostFromDB("{{ post.postID }}", "{{ postType }}")
				{% endif %}
			})

			// Handle select bars
			{% if not hideStatus %}
				addStatusBar("statusDiv", "statusSelect", "{{ post.status }}")
			{% endif %}

			{% if isWork %}
				// Add profession select bar to work post
				var professionDiv = document.getElementById("professionListDiv")
				if(professionDiv != null){
					var professionOptions = {{ professionList|safe }};
					var selectForm = "Profession:" + createSelectForm("createForm", "professionSelect", professionOptions, "{{ chosenProfession }}");
					professionDiv.innerHTML = selectForm;
				}
			{% elif isCasting %}
				// Casting attributes select bar
				{% for attribute in attributes %}
					var attributeDiv = document.getElementById("attributes.{{attribute.name}}Div")
					if(attributeDiv != null){
						{% if attribute.options %}
							var attributeOptions = {{ attribute.options|safe }}
							var selectForm = createSelectForm("createForm", "attributes.{{attribute.name}}", attributeOptions, "{{attribute.value}}")
							attributeDiv.innerHTML = selectForm;

							var attributeSelectForm = document.getElementById("attributes.{{attribute.name}}");
							if(attributeSelectForm != null){
								attributeSelectForm.disabled = "disabled";
							}
						{% endif %}
					}
				{% endfor %}
				{% if post.descriptionEnabled %}
					toggleActorDescriptions();
				{% endif %}
			{% elif isCollaboration %}
				// Add profession select bar to work post
				var collaboratorRoleDiv = document.getElementById("collaboratorRoleDiv")
				if(collaboratorRoleDiv != null){
					var collaboratorRoleOptions = {{ collaboratorRoleOptions|safe }};
					var selectForm = "Collaborator role:" + createSelectForm("createForm", "collaboratorRoleSelect", collaboratorRoleOptions, "{{ collaboratorRole }}");
					collaboratorRoleDiv.innerHTML = selectForm;
				}
			{% endif %}		
		});*/

		function submitForm(){
			var form = document.getElementById("createForm")
			{% if isWork %}
				document.getElementById("id_profession").value = document.getElementById("professionSelect").value;
			{% elif isCollaboration %}
				document.getElementById("id_collaboratorRoleSelect").value = document.getElementById("collaboratorSelect").value;
			{% endif %}
			var statusDiv = document.getElementById("statusSelect");
			if(statusDiv != null){
				document.getElementById("id_status").value = statusDiv.value;
			}
			return form.submit()
			}
	</script>

{% endblock %}
