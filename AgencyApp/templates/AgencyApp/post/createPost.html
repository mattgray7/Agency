{% extends "base.html" %}

{% block content %}
{% load static %}
<script type="text/javascript" src="{% static "/AgencyApp/js/post/post.js" %}"></script>
<script>
        // Submits the form while adding values of select bars with id '{{name}}SelectBar' to form input '{{name}}SelectInput'
        function submitForm(formName){
            var statusDiv = document.getElementById("statusSelectBar");
            if(statusDiv != null){
                // Set the status from the select bar in the form
                document.getElementById("statusSelectInput").value = statusDiv.value;
                console.log("Set status input to " + statusDiv.value)
            }
            {% if selectFields.names %}
                {% for name in selectFields.names %}
                    var selectDiv = document.getElementById('{{name}}SelectBar')
                    if(selectDiv != null){
                        document.getElementById('{{name}}SelectInput').value = selectDiv.value;
                    }
                {% endfor %}
            {% endif %}
            var form = document.getElementById(formName)
            if(form != null){
                return form.submit()
            }
        }

        function getCastingFormDict(){
            var postFields = []
            {% if form %}
                {% spaceless %}
                {% for field in form %}
                    var postField = []
                    postField.push({key: "input", value: '{{field}}'});
                    postField.push({key: "name", value: '{{field.name}}'});
                    postField.push({key: "hidden", value: ('{{field}}'.includes('hidden'))});
                    postField.push({key: "label", value: '{{field.label}}'})

                    var value = '{{field.value}}';
                    {% if field.name == "projectID" %}
                        value = "{{post.projectID}}";
                    {% elif field.name == "postPicture" %}
                        {% if post.postPicture and post.postPicture.url %}
                            value = "{{post.postPicture.url}}";
                        {% else %}
                            value = "{{images.noPicture}}";
                        {% endif %}
                    {% elif field.name == "status" %}
                        {% if statusOptions.roles %}
                            var options = {{ statusOptions.roles|safe }}
                            postField.push({key: "options", value: options});
                        {% endif %}
                    {% elif field.name == "description" %}
                        postField.push({key: "numRows", value: "20"})
                    {% elif field.name in selectFields.names %}
                        {% if selectFields.options %}
                            var options = {{ selectFields.options|safe }}
                            postField.push({key: "options", value: options['{{field.name}}']});

                            /*{% if selectFields.defaults %}
                                var selectValues = {{selectFields.defaults|safe}}
                                value = selectValues['{{field.name}}'];
                            {% endif %}*/
                        {% endif %}
                    {% endif %}
                    postField.push({key: "value", value: value});
                    postFields.push(postField);
                {% endfor %}
                {% endspaceless %}
                var csrfField = []
                csrfField.push({key: "input", value: "{% csrf_token %}"});
                csrfField.push({key: "name", value: 'csrf_token'});
                postFields.push(csrfField);

                var cancelButton = [];
                var cancelOnclick = 'redirectToPost("{{post.postID}}");';
                console.log(cancelOnclick)
                cancelButton.push({key: "cancelButtonOnclick", value: cancelOnclick});
                postFields.push(cancelButton);
            {% endif %}
            return postFields;
        }
</script>
<div id="mainViewPanel" class="mainViewPanel" style="display:block">
	{% if post %}
		<div id="editPostPanel" class="editPostPanel">
			{% if isCasting %}
				<div id="postForm"></div>					
			{% endif %}
		</div>
		<script>
			var postFormDiv = document.getElementById("postForm");
			if(postFormDiv != null){
				var projectInfo = [];
				{% if project and project.title %}
                    projectInfo.push({key: "title", value: '{{ project.title }}'});
                    projectInfo.push({key: "projectID", value: '{{ project.postID }}'})
                {% endif %}
				newForm = addCreateCastingPost(getCastingFormDict(), "{{currentPageURL}}", "createCastingPostForm", projectInfo);
				postFormDiv.innerHTML = newForm;
				$("#id_postPicture").change(function(){
					previewPicture(this, "postPictureImg");
				});
			}
		</script>
	{% else %}
		No post found.
	{% endif %}
</div>
	<!--{% if errors %}
		<ul>
			{% for error in errors %}
				<li>{{ error }}</li>
			{% endfor %}
		</ul>
	{% endif %}

	<h3>
		{% if isEvent %}
			{% if post.title %}
				Update event
			{% else %}
				Create event
			{% endif %}
		{% elif isProject %}
			{% if post.title %}
				Update project
			{% else %}
				Create project
			{% endif %}
		{% elif isCollaboration %}
			{% if post.title %}
				Update collaboration post
			{% else %}
				Create collaboration post
			{% endif %}
		{% elif isWork %}
			{% if post.title %}
				Update work post
			{% else %}
				Create work post
			{% endif %}
		{% elif isCasting %}
			{% if post.title %}
				Update casting post
			{% else %}
				Create casting post
			{% endif %}
		{% endif %}
	</h3>

	{% if post.postPicture %}
		<div id="postPicture">
			<img src="{{ post.postPicture.url }}" height="150px" width="120px"/>
		</div>
	{% endif %}

	{% if post.title %}
		<form method='post' action="/post/edit/{{post.postID}}/" name='createForm' id='createForm' enctype="multipart/form-data" onsubmit="return submitForm()">
	{% else %}
		{% if isEvent %}
			<form method='post' action="/post/create/event/" name='createForm' id='createForm' enctype="multipart/form-data" onsubmit="return submitForm()">
		{% elif isProject %}
			<form method='post' action="/post/create/project/" name='createForm' id='createForm' enctype="multipart/form-data" onsubmit="return submitForm()">
		{% elif isCollaboration %}
			<form method='post' action="/post/create/collaboration/" name='createForm' id='createForm' enctype="multipart/form-data" onsubmit="return submitForm()">
		{% elif isWork %}
			<form method='post' action="/post/create/work/" name='createForm' id='createForm' enctype="multipart/form-data" onsubmit="return submitForm()">
		{% elif isCasting %}
			<form method='post' action="/post/create/casting/" name='createForm' id='createForm' enctype="multipart/form-data" onsubmit="return submitForm()">
		{% endif %}
	{% endif %}
	{% csrf_token %}
	{{ form.as_p }}
	{% if not hideStatus %}
		Status: <div id="statusDiv" style="display:inline"></div><br><br>
	{% endif %}

	{% if isCasting %}
			<script>
			function toggleActorDescriptions(){
				// Create input list
				var tagInputs = document.getElementsByTagName("input")
				var selectInputs = document.getElementsByTagName("select");
				var inputs = []
				for(var i=0; i < tagInputs.length; i++){
					inputs.push(tagInputs[i]);
				}
				for(var i=0; i < selectInputs.length; i++){
					inputs.push(selectInputs[i]);
				}

				// toggle the enable
				for(var i=0; i < inputs.length; i++){
					var currentInput = inputs[i]
					if(currentInput.id.substring(0, 10) == "attributes"){
						if(currentInput.disabled){
							currentInput.disabled = false;
							document.getElementById("physicalAttributesEnabledDiv").innerHTML = "<input type='hidden' name='descriptionEnabled' value='True' />";
							document.getElementById("physicalAttributesDivLabel").innerHTML = '<font color="black">Physical attributes</font>';
						}else{
							currentInput.disabled = true;
							document.getElementById("physicalAttributesEnabledDiv").innerHTML = "<input type='hidden' name='descriptionEnabled' value='False' />";
							document.getElementById("physicalAttributesDivLabel").innerHTML = '<font color="gray">Physical attributes</font>';
						}
					}
				}
			}
			</script>
			<br>
			<h5 style="display:inline;"> You can specify the physical characteristics of the role, which we can use to notify actors with matching traits of your casting post. Your post will still be visible without physical criteria enabled.</h5>
			<br>
			Enable physical attributes
			{% if descriptionEnabled %}
				<input type="checkbox" onclick="toggleActorDescriptions();" value="Enable physical criteria" checked/>
			{% else %}
				<input type="checkbox" onclick="toggleActorDescriptions();" value="Enable physical criteria"/>
			{% endif %}
			<br><br>

			<div id="physicalAttributesDiv">
				<h4 style="display:inline;">
					<div id="physicalAttributesDivLabel"><font color="gray">Physical attributes</font></div>
				</h4>
				<table>
					<script>
					var attributeDivIdList = [];
					</script>
					{% for attribute in attributes %}
						<tr><td>
							<script>
							function changeAttributeBool(attributeName, newBoolValue){
								var attributeInputDiv = document.getElementById(attributeName + "BoolDiv");
								if(attributeInputDiv != null){
									attributeInputDiv.innerHTML = "<input type='hidden' name='attributes.{{attribute.name}}' value='" + newBoolValue + "'>"
								}
							}
							</script>
							{{attribute.name}}: 
							{% if attribute.value == True or attribute.value == "True" %}
								<div id="{{attribute.name}}BoolDiv"></div>
								<input type='checkbox' value='{{attribute.value}}' id="attributes.{{attribute.name}}" name='{{attribute.name}}' disabled='disabled' onclick='changeAttributeBool("{{attribute.name}}", "False");' checked>
							{% elif attribute.value == False or attribute.value == "False" %}
								<div id="{{attribute.name}}BoolDiv"></div>
								<input type='checkbox' value='{{attribute.value}}' id="attributes.{{attribute.name}}" name='{{attribute.name}}' disabled='disabled' onclick='changeAttributeBool("{{attribute.name}}", "True");' >
							{% else %}
								{% if attribute.options %}
									<div id="attributes.{{attribute.name}}Div"></div>
								{% elif attribute.value and attribute.value != "None" %}
									<input type='text' value='{{attribute.value}}' id="attributes.{{attribute.name}}" name="attributes.{{attribute.name}}" disabled='disabled'>
								{% else %}
									<input type='text' value='' id="attributes.{{attribute.name}}" name="attributes.{{attribute.name}}" disabled='disabled'>
								{% endif %}
							{% endif %}
							</td></tr>
					{% endfor %}

				</table>
				<div id="physicalAttributesEnabledDiv" style="display:inline";>
					<input type='hidden' name='descriptionEnabled' value='{{ descriptionEnabled }}' />
				</div>
			</div>

	{% elif isWork %}
		<div id='professionListDiv'></div><br>
	{% elif isCollaboration %}
		<div id='collaboratorRoleDiv'></div><br>
	{% endif %}

	{% if post.title %}
		<input type="submit" value="Update" />
	{% else %}
		<input type="submit" value="Create" />
	{% endif %}
	</form>
	<div id="cancelButton" class="button"><div id="cancelButtonLabel"></div>
</div>

<script>
		/*$(document).ready(function(){
			// run a deconstructor to delete a post from the db if user navigates away from this page without canceling
			toolbarDeconstructorFunctions.push(function(){
				{% if not post.record.title %}
					// New record, need to delete
					deletePostFromDB("{{ post.postID }}", "{{ postType }}")
				{% endif %}
			})

			// Handle select bars
			{% if not hideStatus %}
				addStatusBar("statusDiv", "statusSelect", "{{ post.status }}")
			{% endif %}

			{% if isWork %}
				// Add profession select bar to work post
				var professionDiv = document.getElementById("professionListDiv")
				if(professionDiv != null){
					var professionOptions = {{ professionList|safe }};
					var selectForm = "Profession:" + createSelectForm("createForm", "professionSelect", professionOptions, "{{ chosenProfession }}");
					professionDiv.innerHTML = selectForm;
				}
			{% elif isCasting %}
				// Casting attributes select bar
				{% for attribute in attributes %}
					var attributeDiv = document.getElementById("attributes.{{attribute.name}}Div")
					if(attributeDiv != null){
						{% if attribute.options %}
							var attributeOptions = {{ attribute.options|safe }}
							var selectForm = createSelectForm("createForm", "attributes.{{attribute.name}}", attributeOptions, "{{attribute.value}}")
							attributeDiv.innerHTML = selectForm;

							var attributeSelectForm = document.getElementById("attributes.{{attribute.name}}");
							if(attributeSelectForm != null){
								attributeSelectForm.disabled = "disabled";
							}
						{% endif %}
					}
				{% endfor %}
				{% if post.descriptionEnabled %}
					toggleActorDescriptions();
				{% endif %}
			{% elif isCollaboration %}
				// Add profession select bar to work post
				var collaboratorRoleDiv = document.getElementById("collaboratorRoleDiv")
				if(collaboratorRoleDiv != null){
					var collaboratorRoleOptions = {{ collaboratorRoleOptions|safe }};
					var selectForm = "Collaborator role:" + createSelectForm("createForm", "collaboratorRoleSelect", collaboratorRoleOptions, "{{ collaboratorRole }}");
					collaboratorRoleDiv.innerHTML = selectForm;
				}
			{% endif %}		
		});*/

		function submitForm(){
			var form = document.getElementById("createForm")
			{% if isWork %}
				document.getElementById("id_profession").value = document.getElementById("professionSelect").value;
			{% elif isCollaboration %}
				document.getElementById("id_collaboratorRoleSelect").value = document.getElementById("collaboratorSelect").value;
			{% endif %}
			var statusDiv = document.getElementById("statusSelect");
			if(statusDiv != null){
				document.getElementById("id_status").value = statusDiv.value;
			}
			return form.submit()
			}
	</script>-->

{% endblock %}
